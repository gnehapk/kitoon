// <reference path="../../../typings/tsd.d.ts" />
var ModalHelpers = require('../../modal/modal-helpers');
var libs_1 = require('../../base/libs');
var BlockDeviceController = (function () {
    function BlockDeviceController($routeParams, $location, $log, $q, $modal, clusterSvc, storageSvc, blockDeviceSvc, requestTrackingSvc, requestSvc) {
        var _this = this;
        this.$routeParams = $routeParams;
        this.$location = $location;
        this.$log = $log;
        this.$q = $q;
        this.$modal = $modal;
        this.clusterSvc = clusterSvc;
        this.storageSvc = storageSvc;
        this.blockDeviceSvc = blockDeviceSvc;
        this.requestTrackingSvc = requestTrackingSvc;
        this.requestSvc = requestSvc;
        this.devicesToCreate = 1;
        this.targetSize = { value: 1, unit: 'GB' };
        this.sizeUnits = ['GB', 'TB'];
        this.useExistingPool = true;
        this.summary = false;
        this.devicesSize = 0;
        var clusterId = $routeParams['clusterid'];
        this.clusterSvc.get(clusterId).then(function (cluster) {
            _this.cluster = cluster;
            return _this.storageSvc.getListByCluster(_this.cluster.clusterid);
        }).then(function (pools) {
            _this.existingPools = [];
            _.each(pools, function (pool) {
                pool.capacity = {
                    total: pool.usage.total,
                    used: pool.usage.used
                };
                pool.utilization = {};
                if (pool.type === 'replicated') {
                    _this.existingPools.push(pool);
                }
            });
            if (_this.existingPools.length > 0) {
                _this.selectedPool = _this.existingPools[0];
                _this.processUtilization();
                _this.useExistingPool = true;
            }
            else {
                _this.useExistingPool = false;
            }
        });
        this.rbdList = [];
    }
    BlockDeviceController.prototype.processUtilization = function () {
        this.devicesSize = libs_1.numeral().unformat(this.targetSize.value + this.targetSize.unit) * this.devicesToCreate;
        if (this.devicesSize <= this.selectedPool.capacity.total) {
            var inUsePercent = Math.round((this.selectedPool.capacity.used / this.selectedPool.capacity.total) * 100);
            var toBeUsedPercent = Math.round((this.devicesSize / this.selectedPool.capacity.total) * 100);
            var remainingSize = this.selectedPool.capacity.total - this.selectedPool.capacity.used - this.devicesSize;
            var remainingPercent = 100 - inUsePercent - toBeUsedPercent;
            this.selectedPool.utilization.data = [
                { "used": inUsePercent, "color": "#00a8e1", "subtitle": "" },
                { "used": toBeUsedPercent, "color": "#3F9C35", "subtitle": libs_1.numeral(this.devicesSize).format('0.0 b') + " to be added" },
                { "used": remainingPercent, "color": "#EDEDED", "subtitle": libs_1.numeral(remainingSize).format('0.0 b') + " remaining" }
            ];
        }
    };
    BlockDeviceController.prototype.getDeviceNameList = function (deviceName, count) {
        var list = [];
        if (deviceName && deviceName.trim().length > 0) {
            for (var index = 1; index <= count; index++) {
                var suffix = count > 1 ? index : '';
                list.push(deviceName + suffix);
            }
        }
        return list;
    };
    BlockDeviceController.prototype.getBlockDeviceNames = function (deviceName, count) {
        if (count > 1) {
            return this.getDeviceNameList(deviceName, count).join(', ');
        }
        else {
            return null;
        }
    };
    BlockDeviceController.prototype.prepareSummary = function () {
        var _this = this;
        var list = this.getDeviceNameList(this.deviceName, this.devicesToCreate);
        _.each(list, function (device) {
            var rbd = {
                name: device,
                size: _this.targetSize
            };
            _this.rbdList.push(rbd);
        });
        this.summary = true;
    };
    BlockDeviceController.prototype.removeBlockDevice = function (deviceName) {
        _.remove(this.rbdList, function (rbd) { return rbd.name === deviceName; });
    };
    BlockDeviceController.prototype.cancel = function () {
        this.$location.path('/rbds/');
    };
    BlockDeviceController.prototype.submit = function () {
        var _this = this;
        var list = [];
        _.each(this.rbdList, function (rbd) {
            var blockdevice = {
                name: rbd.name,
                size: rbd.size.value + rbd.size.unit
            };
            list.push(_this.blockDeviceSvc.add(_this.cluster.clusterid, _this.selectedPool.storageid, blockdevice));
        });
        this.$q.all(list).then(function (tasks) {
            for (var _i = 0; _i < tasks.length; _i++) {
                var task = tasks[_i];
                _this.requestSvc.get(task.data.taskid).then(function (result) {
                    _this.requestTrackingSvc.add(result.id, result.name);
                });
            }
        });
        var modal = ModalHelpers.SuccessfulRequest(this.$modal, {
            title: 'Add Block Storage Request is Submitted',
            container: '.usmClientApp'
        });
        modal.$scope.$hide = _.wrap(modal.$scope.$hide, function ($hide) {
            $hide();
            _this.$location.path('/rbds/');
        });
    };
    BlockDeviceController.$inject = [
        '$routeParams',
        '$location',
        '$log',
        '$q',
        '$modal',
        'ClusterService',
        'StorageService',
        'BlockDeviceService',
        'RequestTrackingService',
        'RequestService'
    ];
    return BlockDeviceController;
})();
exports.BlockDeviceController = BlockDeviceController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvc3RvcmFnZS9ibG9ja2RldmljZS9ibG9ja2RldmljZS1uZXcudHMiXSwibmFtZXMiOlsiQmxvY2tEZXZpY2VDb250cm9sbGVyIiwiQmxvY2tEZXZpY2VDb250cm9sbGVyLmNvbnN0cnVjdG9yIiwiQmxvY2tEZXZpY2VDb250cm9sbGVyLnByb2Nlc3NVdGlsaXphdGlvbiIsIkJsb2NrRGV2aWNlQ29udHJvbGxlci5nZXREZXZpY2VOYW1lTGlzdCIsIkJsb2NrRGV2aWNlQ29udHJvbGxlci5nZXRCbG9ja0RldmljZU5hbWVzIiwiQmxvY2tEZXZpY2VDb250cm9sbGVyLnByZXBhcmVTdW1tYXJ5IiwiQmxvY2tEZXZpY2VDb250cm9sbGVyLnJlbW92ZUJsb2NrRGV2aWNlIiwiQmxvY2tEZXZpY2VDb250cm9sbGVyLmNhbmNlbCIsIkJsb2NrRGV2aWNlQ29udHJvbGxlci5zdWJtaXQiXSwibWFwcGluZ3MiOiJBQUFBLGlEQUFpRDtBQVlqRCxJQUFZLFlBQVksV0FBTSwyQkFBMkIsQ0FBQyxDQUFBO0FBQzFELHFCQUFzQixpQkFBaUIsQ0FBQyxDQUFBO0FBRXhDO0lBeUJJQSwrQkFBb0JBLFlBQTBDQSxFQUNsREEsU0FBOEJBLEVBQzlCQSxJQUFvQkEsRUFDcEJBLEVBQWdCQSxFQUNoQkEsTUFBTUEsRUFDTkEsVUFBMEJBLEVBQzFCQSxVQUEwQkEsRUFDMUJBLGNBQWtDQSxFQUNsQ0Esa0JBQTBDQSxFQUMxQ0EsVUFBMEJBO1FBbEMxQ0MsaUJBZ0pDQTtRQXZIdUJBLGlCQUFZQSxHQUFaQSxZQUFZQSxDQUE4QkE7UUFDbERBLGNBQVNBLEdBQVRBLFNBQVNBLENBQXFCQTtRQUM5QkEsU0FBSUEsR0FBSkEsSUFBSUEsQ0FBZ0JBO1FBQ3BCQSxPQUFFQSxHQUFGQSxFQUFFQSxDQUFjQTtRQUNoQkEsV0FBTUEsR0FBTkEsTUFBTUEsQ0FBQUE7UUFDTkEsZUFBVUEsR0FBVkEsVUFBVUEsQ0FBZ0JBO1FBQzFCQSxlQUFVQSxHQUFWQSxVQUFVQSxDQUFnQkE7UUFDMUJBLG1CQUFjQSxHQUFkQSxjQUFjQSxDQUFvQkE7UUFDbENBLHVCQUFrQkEsR0FBbEJBLGtCQUFrQkEsQ0FBd0JBO1FBQzFDQSxlQUFVQSxHQUFWQSxVQUFVQSxDQUFnQkE7UUEvQjlCQSxvQkFBZUEsR0FBV0EsQ0FBQ0EsQ0FBQ0E7UUFDNUJBLGVBQVVBLEdBQUdBLEVBQUVBLEtBQUtBLEVBQUVBLENBQUNBLEVBQUVBLElBQUlBLEVBQUVBLElBQUlBLEVBQUVBLENBQUNBO1FBQ3RDQSxjQUFTQSxHQUFHQSxDQUFDQSxJQUFJQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUV6QkEsb0JBQWVBLEdBQUdBLElBQUlBLENBQUNBO1FBR3ZCQSxZQUFPQSxHQUFZQSxLQUFLQSxDQUFDQTtRQXlCN0JBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3JCQSxJQUFJQSxTQUFTQSxHQUFHQSxZQUFZQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQTtRQUMxQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBQUEsT0FBT0E7WUFDdkNBLEtBQUlBLENBQUNBLE9BQU9BLEdBQUdBLE9BQU9BLENBQUNBO1lBQ3ZCQSxNQUFNQSxDQUFDQSxLQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxnQkFBZ0JBLENBQUNBLEtBQUlBLENBQUNBLE9BQU9BLENBQUNBLFNBQVNBLENBQUNBLENBQUNBO1FBQ3BFQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFBQSxLQUFLQTtZQUNUQSxLQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUN4QkEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsRUFBRUEsVUFBQ0EsSUFBSUE7Z0JBQ2ZBLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBO29CQUNaQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxLQUFLQTtvQkFDdkJBLElBQUlBLEVBQUVBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBO2lCQUN4QkEsQ0FBQ0E7Z0JBQ0ZBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLEVBQUVBLENBQUNBO2dCQUN0QkEsRUFBRUEsQ0FBQUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsS0FBS0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQzVCQSxLQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDbENBLENBQUNBO1lBQ0xBLENBQUNBLENBQUNBLENBQUNBO1lBQ0hBLEVBQUVBLENBQUNBLENBQUNBLEtBQUlBLENBQUNBLGFBQWFBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUNoQ0EsS0FBSUEsQ0FBQ0EsWUFBWUEsR0FBR0EsS0FBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzFDQSxLQUFJQSxDQUFDQSxrQkFBa0JBLEVBQUVBLENBQUNBO2dCQUMxQkEsS0FBSUEsQ0FBQ0EsZUFBZUEsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDaENBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLENBQUNBO2dCQUNGQSxLQUFJQSxDQUFDQSxlQUFlQSxHQUFHQSxLQUFLQSxDQUFDQTtZQUNqQ0EsQ0FBQ0E7UUFDTEEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDSEEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsRUFBRUEsQ0FBQ0E7SUFDdEJBLENBQUNBO0lBRU1ELGtEQUFrQkEsR0FBekJBO1FBQ0lFLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLGNBQU9BLEVBQUVBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBO1FBQzNHQSxFQUFFQSxDQUFBQSxDQUFFQSxJQUFJQSxDQUFDQSxXQUFXQSxJQUFJQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxRQUFRQSxDQUFDQSxLQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN4REEsSUFBSUEsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDMUdBLElBQUlBLGVBQWVBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLFFBQVFBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1lBQzlGQSxJQUFJQSxhQUFhQSxHQUFHQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxRQUFRQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQTtZQUMxR0EsSUFBSUEsZ0JBQWdCQSxHQUFHQSxHQUFHQSxHQUFHQSxZQUFZQSxHQUFHQSxlQUFlQSxDQUFDQTtZQUM1REEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsR0FBR0E7Z0JBQ2pDQSxFQUFFQSxNQUFNQSxFQUFFQSxZQUFZQSxFQUFFQSxPQUFPQSxFQUFFQSxTQUFTQSxFQUFFQSxVQUFVQSxFQUFFQSxFQUFFQSxFQUFFQTtnQkFDNURBLEVBQUVBLE1BQU1BLEVBQUVBLGVBQWVBLEVBQUVBLE9BQU9BLEVBQUVBLFNBQVNBLEVBQUVBLFVBQVVBLEVBQUVBLGNBQU9BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLGNBQWNBLEVBQUVBO2dCQUN2SEEsRUFBRUEsTUFBTUEsRUFBRUEsZ0JBQWdCQSxFQUFFQSxPQUFPQSxFQUFFQSxTQUFTQSxFQUFFQSxVQUFVQSxFQUFFQSxjQUFPQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxZQUFZQSxFQUFFQTthQUN0SEEsQ0FBQUE7UUFDTEEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFTUYsaURBQWlCQSxHQUF4QkEsVUFBeUJBLFVBQWtCQSxFQUFFQSxLQUFhQTtRQUN0REcsSUFBSUEsSUFBSUEsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFDZEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsVUFBVUEsSUFBSUEsVUFBVUEsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDN0NBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEtBQUtBLEdBQUdBLENBQUNBLEVBQUVBLEtBQUtBLElBQUlBLEtBQUtBLEVBQUVBLEtBQUtBLEVBQUVBLEVBQUVBLENBQUNBO2dCQUMxQ0EsSUFBSUEsTUFBTUEsR0FBR0EsS0FBS0EsR0FBR0EsQ0FBQ0EsR0FBR0EsS0FBS0EsR0FBR0EsRUFBRUEsQ0FBQ0E7Z0JBQ3BDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxNQUFNQSxDQUFDQSxDQUFDQTtZQUNuQ0EsQ0FBQ0E7UUFDTEEsQ0FBQ0E7UUFDREEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7SUFDaEJBLENBQUNBO0lBRU1ILG1EQUFtQkEsR0FBMUJBLFVBQTJCQSxVQUFrQkEsRUFBRUEsS0FBYUE7UUFDeERJLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ1pBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsVUFBVUEsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDaEVBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLENBQUNBO1lBQ0ZBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBQ2hCQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVNSiw4Q0FBY0EsR0FBckJBO1FBQUFLLGlCQVVDQTtRQVRHQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBO1FBQ3pFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxVQUFBQSxNQUFNQTtZQUNmQSxJQUFJQSxHQUFHQSxHQUFHQTtnQkFDTkEsSUFBSUEsRUFBRUEsTUFBTUE7Z0JBQ1pBLElBQUlBLEVBQUVBLEtBQUlBLENBQUNBLFVBQVVBO2FBQ3hCQSxDQUFBQTtZQUNEQSxLQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUMzQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDSEEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0E7SUFDeEJBLENBQUNBO0lBRU1MLGlEQUFpQkEsR0FBeEJBLFVBQXlCQSxVQUFrQkE7UUFDdkNNLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLFVBQUFBLEdBQUdBLElBQUlBLE9BQUFBLEdBQUdBLENBQUNBLElBQUlBLEtBQUtBLFVBQVVBLEVBQXZCQSxDQUF1QkEsQ0FBQ0EsQ0FBQ0E7SUFDM0RBLENBQUNBO0lBRU1OLHNDQUFNQSxHQUFiQTtRQUNJTyxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUNsQ0EsQ0FBQ0E7SUFFTVAsc0NBQU1BLEdBQWJBO1FBQUFRLGlCQXdCQ0E7UUF2QkdBLElBQUlBLElBQUlBLEdBQUdBLEVBQUVBLENBQUNBO1FBQ2RBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLFVBQUNBLEdBQUdBO1lBQ3JCQSxJQUFJQSxXQUFXQSxHQUFnQkE7Z0JBQzNCQSxJQUFJQSxFQUFFQSxHQUFHQSxDQUFDQSxJQUFJQTtnQkFDZEEsSUFBSUEsRUFBRUEsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUE7YUFDdkNBLENBQUNBO1lBQ0ZBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEtBQUlBLENBQUNBLGNBQWNBLENBQUNBLEdBQUdBLENBQUNBLEtBQUlBLENBQUNBLE9BQU9BLENBQUNBLFNBQVNBLEVBQUVBLEtBQUlBLENBQUNBLFlBQVlBLENBQUNBLFNBQVNBLEVBQUVBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1FBQ3pHQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNIQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFDQSxLQUFLQTtZQUN6QkEsR0FBR0EsQ0FBQ0EsQ0FBYUEsVUFBS0EsRUFBakJBLGlCQUFRQSxFQUFSQSxJQUFpQkEsQ0FBQ0E7Z0JBQWxCQSxJQUFJQSxJQUFJQSxHQUFJQSxLQUFLQSxJQUFUQTtnQkFDVEEsS0FBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBQ0EsTUFBTUE7b0JBQzlDQSxLQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBLEVBQUVBLEVBQUVBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUN4REEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7YUFDTkE7UUFDTEEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDSEEsSUFBSUEsS0FBS0EsR0FBR0EsWUFBWUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQTtZQUNwREEsS0FBS0EsRUFBRUEsd0NBQXdDQTtZQUMvQ0EsU0FBU0EsRUFBRUEsZUFBZUE7U0FDN0JBLENBQUNBLENBQUNBO1FBQ0hBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLEVBQUVBLFVBQUNBLEtBQUtBO1lBQ2xEQSxLQUFLQSxFQUFFQSxDQUFDQTtZQUNSQSxLQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUNsQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7SUFsSU1SLDZCQUFPQSxHQUFrQkE7UUFDNUJBLGNBQWNBO1FBQ2RBLFdBQVdBO1FBQ1hBLE1BQU1BO1FBQ05BLElBQUlBO1FBQ0pBLFFBQVFBO1FBQ1JBLGdCQUFnQkE7UUFDaEJBLGdCQUFnQkE7UUFDaEJBLG9CQUFvQkE7UUFDcEJBLHdCQUF3QkE7UUFDeEJBLGdCQUFnQkE7S0FDbkJBLENBQUNBO0lBd0hOQSw0QkFBQ0E7QUFBREEsQ0FoSkEsQUFnSkNBLElBQUE7QUFoSlksNkJBQXFCLHdCQWdKakMsQ0FBQSIsImZpbGUiOiJtb2R1bGVzL3N0b3JhZ2UvYmxvY2tkZXZpY2UvYmxvY2tkZXZpY2UtbmV3LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vLi4vdHlwaW5ncy90c2QuZC50c1wiIC8+XG5cbmltcG9ydCB7Q2x1c3Rlcn0gZnJvbSAnLi4vLi4vcmVzdC9jbHVzdGVycyc7XG5pbXBvcnQge1N0b3JhZ2VQcm9maWxlfSBmcm9tICcuLi8uLi9yZXN0L3N0b3JhZ2UtcHJvZmlsZSc7XG5pbXBvcnQge0Jsb2NrRGV2aWNlfSBmcm9tICcuLi8uLi9yZXN0L2Jsb2NrZGV2aWNlJztcblxuaW1wb3J0IHtDbHVzdGVyU2VydmljZX0gZnJvbSAnLi4vLi4vcmVzdC9jbHVzdGVycyc7XG5pbXBvcnQge1N0b3JhZ2VQcm9maWxlU2VydmljZX0gZnJvbSAnLi4vLi4vcmVzdC9zdG9yYWdlLXByb2ZpbGUnO1xuaW1wb3J0IHtTdG9yYWdlU2VydmljZX0gZnJvbSAnLi4vLi4vcmVzdC9zdG9yYWdlJztcbmltcG9ydCB7QmxvY2tEZXZpY2VTZXJ2aWNlfSBmcm9tICcuLi8uLi9yZXN0L2Jsb2NrZGV2aWNlJztcbmltcG9ydCB7UmVxdWVzdFNlcnZpY2V9IGZyb20gJy4uLy4uL3Jlc3QvcmVxdWVzdCc7XG5pbXBvcnQge1JlcXVlc3RUcmFja2luZ1NlcnZpY2V9IGZyb20gJy4uLy4uL3JlcXVlc3RzL3JlcXVlc3QtdHJhY2tpbmctc3ZjJztcbmltcG9ydCAqIGFzIE1vZGFsSGVscGVycyBmcm9tICcuLi8uLi9tb2RhbC9tb2RhbC1oZWxwZXJzJztcbmltcG9ydCB7bnVtZXJhbH0gZnJvbSAnLi4vLi4vYmFzZS9saWJzJztcblxuZXhwb3J0IGNsYXNzIEJsb2NrRGV2aWNlQ29udHJvbGxlciB7XG4gICAgcHJpdmF0ZSBjbHVzdGVyOiBDbHVzdGVyO1xuICAgIHByaXZhdGUgZGV2aWNlTmFtZTogc3RyaW5nO1xuICAgIHByaXZhdGUgZGV2aWNlc1RvQ3JlYXRlOiBudW1iZXIgPSAxO1xuICAgIHByaXZhdGUgdGFyZ2V0U2l6ZSA9IHsgdmFsdWU6IDEsIHVuaXQ6ICdHQicgfTtcbiAgICBwcml2YXRlIHNpemVVbml0cyA9IFsnR0InLCAnVEInXTtcbiAgICBwcml2YXRlIGV4aXN0aW5nUG9vbHM6IGFueVtdO1xuICAgIHByaXZhdGUgdXNlRXhpc3RpbmdQb29sID0gdHJ1ZTtcbiAgICBwcml2YXRlIHNlbGVjdGVkUG9vbDogYW55O1xuICAgIHByaXZhdGUgcmJkTGlzdDogYW55W107XG4gICAgcHJpdmF0ZSBzdW1tYXJ5OiBib29sZWFuID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBkZXZpY2VzU2l6ZTogbnVtYmVyO1xuXG4gICAgc3RhdGljICRpbmplY3Q6IEFycmF5PHN0cmluZz4gPSBbXG4gICAgICAgICckcm91dGVQYXJhbXMnLFxuICAgICAgICAnJGxvY2F0aW9uJyxcbiAgICAgICAgJyRsb2cnLFxuICAgICAgICAnJHEnLFxuICAgICAgICAnJG1vZGFsJyxcbiAgICAgICAgJ0NsdXN0ZXJTZXJ2aWNlJyxcbiAgICAgICAgJ1N0b3JhZ2VTZXJ2aWNlJyxcbiAgICAgICAgJ0Jsb2NrRGV2aWNlU2VydmljZScsXG4gICAgICAgICdSZXF1ZXN0VHJhY2tpbmdTZXJ2aWNlJyxcbiAgICAgICAgJ1JlcXVlc3RTZXJ2aWNlJ1xuICAgIF07XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSAkcm91dGVQYXJhbXM6IG5nLnJvdXRlLklSb3V0ZVBhcmFtc1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgJGxvY2F0aW9uOiBuZy5JTG9jYXRpb25TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlICRsb2c6IG5nLklMb2dTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlICRxOiBuZy5JUVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgJG1vZGFsLFxuICAgICAgICBwcml2YXRlIGNsdXN0ZXJTdmM6IENsdXN0ZXJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHN0b3JhZ2VTdmM6IFN0b3JhZ2VTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGJsb2NrRGV2aWNlU3ZjOiBCbG9ja0RldmljZVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgcmVxdWVzdFRyYWNraW5nU3ZjOiBSZXF1ZXN0VHJhY2tpbmdTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHJlcXVlc3RTdmM6IFJlcXVlc3RTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuZGV2aWNlc1NpemUgPSAwO1xuICAgICAgICBsZXQgY2x1c3RlcklkID0gJHJvdXRlUGFyYW1zWydjbHVzdGVyaWQnXTtcbiAgICAgICAgdGhpcy5jbHVzdGVyU3ZjLmdldChjbHVzdGVySWQpLnRoZW4oY2x1c3RlciA9PiB7XG4gICAgICAgICAgICB0aGlzLmNsdXN0ZXIgPSBjbHVzdGVyO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZVN2Yy5nZXRMaXN0QnlDbHVzdGVyKHRoaXMuY2x1c3Rlci5jbHVzdGVyaWQpO1xuICAgICAgICB9KS50aGVuKHBvb2xzID0+IHtcbiAgICAgICAgICAgIHRoaXMuZXhpc3RpbmdQb29scyA9IFtdO1xuICAgICAgICAgICAgXy5lYWNoKHBvb2xzLCAocG9vbCkgPT4ge1xuICAgICAgICAgICAgICAgIHBvb2wuY2FwYWNpdHkgPSB7XG4gICAgICAgICAgICAgICAgICAgIHRvdGFsOiBwb29sLnVzYWdlLnRvdGFsLFxuICAgICAgICAgICAgICAgICAgICB1c2VkOiBwb29sLnVzYWdlLnVzZWRcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHBvb2wudXRpbGl6YXRpb24gPSB7fTtcbiAgICAgICAgICAgICAgICBpZihwb29sLnR5cGUgPT09ICdyZXBsaWNhdGVkJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4aXN0aW5nUG9vbHMucHVzaChwb29sKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmICh0aGlzLmV4aXN0aW5nUG9vbHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRQb29sID0gdGhpcy5leGlzdGluZ1Bvb2xzWzBdO1xuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1V0aWxpemF0aW9uKCk7XG4gICAgICAgICAgICAgICAgdGhpcy51c2VFeGlzdGluZ1Bvb2wgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy51c2VFeGlzdGluZ1Bvb2wgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmJkTGlzdCA9IFtdO1xuICAgIH1cblxuICAgIHB1YmxpYyBwcm9jZXNzVXRpbGl6YXRpb24oKSB7XG4gICAgICAgIHRoaXMuZGV2aWNlc1NpemUgPSBudW1lcmFsKCkudW5mb3JtYXQodGhpcy50YXJnZXRTaXplLnZhbHVlICsgdGhpcy50YXJnZXRTaXplLnVuaXQpICogdGhpcy5kZXZpY2VzVG9DcmVhdGU7XG4gICAgICAgIGlmKCB0aGlzLmRldmljZXNTaXplIDw9IHRoaXMuc2VsZWN0ZWRQb29sLmNhcGFjaXR5LnRvdGFsICkge1xuICAgICAgICAgICAgdmFyIGluVXNlUGVyY2VudCA9IE1hdGgucm91bmQoKHRoaXMuc2VsZWN0ZWRQb29sLmNhcGFjaXR5LnVzZWQgLyB0aGlzLnNlbGVjdGVkUG9vbC5jYXBhY2l0eS50b3RhbCkgKiAxMDApO1xuICAgICAgICAgICAgdmFyIHRvQmVVc2VkUGVyY2VudCA9IE1hdGgucm91bmQoKHRoaXMuZGV2aWNlc1NpemUgLyB0aGlzLnNlbGVjdGVkUG9vbC5jYXBhY2l0eS50b3RhbCkgKiAxMDApO1xuICAgICAgICAgICAgdmFyIHJlbWFpbmluZ1NpemUgPSB0aGlzLnNlbGVjdGVkUG9vbC5jYXBhY2l0eS50b3RhbCAtIHRoaXMuc2VsZWN0ZWRQb29sLmNhcGFjaXR5LnVzZWQgLSB0aGlzLmRldmljZXNTaXplO1xuICAgICAgICAgICAgdmFyIHJlbWFpbmluZ1BlcmNlbnQgPSAxMDAgLSBpblVzZVBlcmNlbnQgLSB0b0JlVXNlZFBlcmNlbnQ7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkUG9vbC51dGlsaXphdGlvbi5kYXRhID0gW1xuICAgICAgICAgICAgICAgIHsgXCJ1c2VkXCI6IGluVXNlUGVyY2VudCwgXCJjb2xvclwiOiBcIiMwMGE4ZTFcIiwgXCJzdWJ0aXRsZVwiOiBcIlwiIH0sXG4gICAgICAgICAgICAgICAgeyBcInVzZWRcIjogdG9CZVVzZWRQZXJjZW50LCBcImNvbG9yXCI6IFwiIzNGOUMzNVwiLCBcInN1YnRpdGxlXCI6IG51bWVyYWwodGhpcy5kZXZpY2VzU2l6ZSkuZm9ybWF0KCcwLjAgYicpICsgXCIgdG8gYmUgYWRkZWRcIiB9LFxuICAgICAgICAgICAgICAgIHsgXCJ1c2VkXCI6IHJlbWFpbmluZ1BlcmNlbnQsIFwiY29sb3JcIjogXCIjRURFREVEXCIsIFwic3VidGl0bGVcIjogbnVtZXJhbChyZW1haW5pbmdTaXplKS5mb3JtYXQoJzAuMCBiJykgKyBcIiByZW1haW5pbmdcIiB9XG4gICAgICAgICAgICBdXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0RGV2aWNlTmFtZUxpc3QoZGV2aWNlTmFtZTogc3RyaW5nLCBjb3VudDogbnVtYmVyKSB7XG4gICAgICAgIHZhciBsaXN0ID0gW107XG4gICAgICAgIGlmIChkZXZpY2VOYW1lICYmIGRldmljZU5hbWUudHJpbSgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMTsgaW5kZXggPD0gY291bnQ7IGluZGV4KyspIHtcbiAgICAgICAgICAgICAgICB2YXIgc3VmZml4ID0gY291bnQgPiAxID8gaW5kZXggOiAnJztcbiAgICAgICAgICAgICAgICBsaXN0LnB1c2goZGV2aWNlTmFtZSArIHN1ZmZpeCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGxpc3Q7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEJsb2NrRGV2aWNlTmFtZXMoZGV2aWNlTmFtZTogc3RyaW5nLCBjb3VudDogbnVtYmVyKSB7XG4gICAgICAgIGlmIChjb3VudCA+IDEpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERldmljZU5hbWVMaXN0KGRldmljZU5hbWUsIGNvdW50KS5qb2luKCcsICcpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgcHJlcGFyZVN1bW1hcnkoKTogdm9pZCB7XG4gICAgICAgIHZhciBsaXN0ID0gdGhpcy5nZXREZXZpY2VOYW1lTGlzdCh0aGlzLmRldmljZU5hbWUsIHRoaXMuZGV2aWNlc1RvQ3JlYXRlKTtcbiAgICAgICAgXy5lYWNoKGxpc3QsIGRldmljZSA9PiB7XG4gICAgICAgICAgICBsZXQgcmJkID0ge1xuICAgICAgICAgICAgICAgIG5hbWU6IGRldmljZSxcbiAgICAgICAgICAgICAgICBzaXplOiB0aGlzLnRhcmdldFNpemVcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucmJkTGlzdC5wdXNoKHJiZCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnN1bW1hcnkgPSB0cnVlO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW1vdmVCbG9ja0RldmljZShkZXZpY2VOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgXy5yZW1vdmUodGhpcy5yYmRMaXN0LCByYmQgPT4gcmJkLm5hbWUgPT09IGRldmljZU5hbWUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjYW5jZWwoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuJGxvY2F0aW9uLnBhdGgoJy9yYmRzLycpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdWJtaXQoKTogdm9pZCB7XG4gICAgICAgIHZhciBsaXN0ID0gW107XG4gICAgICAgIF8uZWFjaCh0aGlzLnJiZExpc3QsIChyYmQpID0+IHtcbiAgICAgICAgICAgIGxldCBibG9ja2RldmljZTogQmxvY2tEZXZpY2UgPSB7XG4gICAgICAgICAgICAgICAgbmFtZTogcmJkLm5hbWUsXG4gICAgICAgICAgICAgICAgc2l6ZTogcmJkLnNpemUudmFsdWUgKyByYmQuc2l6ZS51bml0XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbGlzdC5wdXNoKHRoaXMuYmxvY2tEZXZpY2VTdmMuYWRkKHRoaXMuY2x1c3Rlci5jbHVzdGVyaWQsIHRoaXMuc2VsZWN0ZWRQb29sLnN0b3JhZ2VpZCwgYmxvY2tkZXZpY2UpKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuJHEuYWxsKGxpc3QpLnRoZW4oKHRhc2tzKSA9PiB7XG4gICAgICAgICAgICBmb3IgKHZhciB0YXNrIG9mIHRhc2tzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0U3ZjLmdldCh0YXNrLmRhdGEudGFza2lkKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VHJhY2tpbmdTdmMuYWRkKHJlc3VsdC5pZCwgcmVzdWx0Lm5hbWUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdmFyIG1vZGFsID0gTW9kYWxIZWxwZXJzLlN1Y2Nlc3NmdWxSZXF1ZXN0KHRoaXMuJG1vZGFsLCB7XG4gICAgICAgICAgICB0aXRsZTogJ0FkZCBCbG9jayBTdG9yYWdlIFJlcXVlc3QgaXMgU3VibWl0dGVkJyxcbiAgICAgICAgICAgIGNvbnRhaW5lcjogJy51c21DbGllbnRBcHAnXG4gICAgICAgIH0pO1xuICAgICAgICBtb2RhbC4kc2NvcGUuJGhpZGUgPSBfLndyYXAobW9kYWwuJHNjb3BlLiRoaWRlLCAoJGhpZGUpID0+IHtcbiAgICAgICAgICAgICRoaWRlKCk7XG4gICAgICAgICAgICB0aGlzLiRsb2NhdGlvbi5wYXRoKCcvcmJkcy8nKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19
