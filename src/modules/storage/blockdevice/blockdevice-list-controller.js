// <reference path="../../../../typings/tsd.d.ts" />
var libs_1 = require('../../base/libs');
var ModalHelpers = require('../../modal/modal-helpers');
var BlockDeviceListController = (function () {
    function BlockDeviceListController($scope, $interval, $location, $modal, clusterSvc, blockDeviceSvc, requestSvc, requestTrackingSvc) {
        var _this = this;
        this.$scope = $scope;
        this.$interval = $interval;
        this.$location = $location;
        this.$modal = $modal;
        this.clusterSvc = clusterSvc;
        this.blockDeviceSvc = blockDeviceSvc;
        this.requestSvc = requestSvc;
        this.requestTrackingSvc = requestTrackingSvc;
        this.list = [];
        this.sizeUnits = ['GB', 'TB'];
        this.timer = this.$interval(function () { return _this.refresh(); }, 5000);
        this.$scope.$on('$destroy', function () {
            _this.$interval.cancel(_this.timer);
        });
        this.refresh();
        this.clusterSvc.getList().then(function (clusterlist) {
            _this.clusters = clusterlist;
        });
    }
    BlockDeviceListController.prototype.refresh = function () {
        var _this = this;
        if (this.clusterId) {
            this.blockDeviceSvc.getListByCluster(this.clusterId).then(function (blockdevices) {
                _this.loadData(blockdevices);
            });
        }
        else {
            this.blockDeviceSvc.getList().then(function (blockdevices) {
                _this.loadData(blockdevices);
            });
        }
    };
    BlockDeviceListController.prototype.loadData = function (blockdevices) {
        var _this = this;
        _.each(this.list, function (blockdevice) {
            blockdevice['updated'] = false;
        });
        _.each(blockdevices, function (blockdevice) {
            var item = _.find(_this.list, function (item) { return item.id === blockdevice.id; });
            if (item) {
                item.size = blockdevice.size;
                item['updated'] = true;
            }
            else {
                blockdevice['updated'] = true;
                _this.list.push(blockdevice);
            }
        });
        _.remove(this.list, function (blockdevice) { return !blockdevice['updated']; });
    };
    BlockDeviceListController.prototype.getFormatedSize = function (size) {
        return libs_1.numeral(size).format('0 b');
    };
    BlockDeviceListController.prototype.create = function () {
        this.$location.path('/storage/new').search({ type: 'block' });
    };
    BlockDeviceListController.prototype.showResizeForm = function (rbd) {
        rbd['resize'] = true;
        var sizeValue = rbd.size.substring(0, rbd.size.length - 2);
        var sizeUnit = rbd.size.substring(rbd.size.length - 2);
        var size = { value: parseInt(sizeValue), unit: sizeUnit };
        rbd['targetSize'] = size;
    };
    BlockDeviceListController.prototype.updateSize = function (rbd, newSize) {
        rbd['targetSize'] = newSize;
    };
    BlockDeviceListController.prototype.resize = function (rbd) {
        var _this = this;
        var targetSize = rbd['targetSize'];
        var size = { size: targetSize.value.toString() + targetSize.unit };
        this.blockDeviceSvc.resize(rbd.clusterid, rbd.storageid, rbd.id, size).then(function (task) {
            _this.requestSvc.get(task.data.taskid).then(function (result) {
                _this.requestTrackingSvc.add(result.id, result.name);
            });
        });
        rbd['resize'] = false;
    };
    BlockDeviceListController.prototype.cancelResize = function (rbd) {
        rbd['resize'] = false;
    };
    BlockDeviceListController.prototype.remove = function (rbd) {
        var _this = this;
        var modal = ModalHelpers.RemoveConfirmation(this.$modal, {});
        modal.$scope.$hide = _.wrap(modal.$scope.$hide, function ($hide, confirmed) {
            if (confirmed) {
                _this.blockDeviceSvc.remove(rbd.clusterid, rbd.storageid, rbd.id).then(function (task) {
                    _this.requestSvc.get(task.data.taskid).then(function (result) {
                        _this.requestTrackingSvc.add(result.id, result.name);
                    });
                });
            }
            $hide();
        });
    };
    BlockDeviceListController.prototype.createCluster = function () {
        this.$location.path('/clusters/new');
    };
    BlockDeviceListController.$inject = [
        '$scope',
        '$interval',
        '$location',
        '$modal',
        'ClusterService',
        'BlockDeviceService',
        'RequestService',
        'RequestTrackingService'
    ];
    return BlockDeviceListController;
})();
exports.BlockDeviceListController = BlockDeviceListController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvc3RvcmFnZS9ibG9ja2RldmljZS9ibG9ja2RldmljZS1saXN0LWNvbnRyb2xsZXIudHMiXSwibmFtZXMiOlsiQmxvY2tEZXZpY2VMaXN0Q29udHJvbGxlciIsIkJsb2NrRGV2aWNlTGlzdENvbnRyb2xsZXIuY29uc3RydWN0b3IiLCJCbG9ja0RldmljZUxpc3RDb250cm9sbGVyLnJlZnJlc2giLCJCbG9ja0RldmljZUxpc3RDb250cm9sbGVyLmxvYWREYXRhIiwiQmxvY2tEZXZpY2VMaXN0Q29udHJvbGxlci5nZXRGb3JtYXRlZFNpemUiLCJCbG9ja0RldmljZUxpc3RDb250cm9sbGVyLmNyZWF0ZSIsIkJsb2NrRGV2aWNlTGlzdENvbnRyb2xsZXIuc2hvd1Jlc2l6ZUZvcm0iLCJCbG9ja0RldmljZUxpc3RDb250cm9sbGVyLnVwZGF0ZVNpemUiLCJCbG9ja0RldmljZUxpc3RDb250cm9sbGVyLnJlc2l6ZSIsIkJsb2NrRGV2aWNlTGlzdENvbnRyb2xsZXIuY2FuY2VsUmVzaXplIiwiQmxvY2tEZXZpY2VMaXN0Q29udHJvbGxlci5yZW1vdmUiLCJCbG9ja0RldmljZUxpc3RDb250cm9sbGVyLmNyZWF0ZUNsdXN0ZXIiXSwibWFwcGluZ3MiOiJBQUFBLG9EQUFvRDtBQU9wRCxxQkFBc0IsaUJBQWlCLENBQUMsQ0FBQTtBQUN4QyxJQUFZLFlBQVksV0FBTSwyQkFBMkIsQ0FBQyxDQUFBO0FBRzFEO0lBZ0JJQSxtQ0FDWUEsTUFBaUJBLEVBQ2pCQSxTQUE4QkEsRUFDOUJBLFNBQThCQSxFQUM5QkEsTUFBTUEsRUFDTkEsVUFBMEJBLEVBQzFCQSxjQUFrQ0EsRUFDbENBLFVBQTBCQSxFQUMxQkEsa0JBQTBDQTtRQXhCMURDLGlCQXVIQ0E7UUF0R2VBLFdBQU1BLEdBQU5BLE1BQU1BLENBQVdBO1FBQ2pCQSxjQUFTQSxHQUFUQSxTQUFTQSxDQUFxQkE7UUFDOUJBLGNBQVNBLEdBQVRBLFNBQVNBLENBQXFCQTtRQUM5QkEsV0FBTUEsR0FBTkEsTUFB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QUNBO0lBQ1BBLENBQUNBO0lBRU1WLGlEQUFhQSxHQUFwQkE7UUFDSVcsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsQ0FBQ0E7SUFDekNBLENBQUNBO0lBaEhNWCxpQ0FBT0EsR0FBa0JBO1FBQzVCQSxRQUFRQTtRQUNSQSxXQUFXQTtRQUNYQSxXQUFXQTtRQUNYQSxRQUFRQTtRQUNSQSxnQkFBZ0JBO1FBQ2hCQSxvQkFBb0JBO1FBQ3BCQSxnQkFBZ0JBO1FBQ2hCQSx3QkFBd0JBO0tBQzNCQSxDQUFDQTtJQXdHTkEsZ0NBQUNBO0FBQURBLENBdkhBLEFBdUhDQSxJQUFBO0FBdkhZLGlDQUF5Qiw0QkF1SHJDLENBQUEiLCJmaWxlIjoibW9kdWxlcy9zdG9yYWdlL2Jsb2NrZGV2aWNlL2Jsb2NrZGV2aWNlLWxpc3QtY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uLy4uLy4uL3R5cGluZ3MvdHNkLmQudHNcIiAvPlxuXG5pbXBvcnQge0Jsb2NrRGV2aWNlU2VydmljZX0gZnJvbSAnLi4vLi4vcmVzdC9ibG9ja2RldmljZSc7XG5pbXBvcnQge0Jsb2NrRGV2aWNlfSBmcm9tICcuLi8uLi9yZXN0L2Jsb2NrZGV2aWNlJztcbmltcG9ydCB7Q2x1c3RlclNlcnZpY2V9IGZyb20gJy4uLy4uL3Jlc3QvY2x1c3RlcnMnO1xuaW1wb3J0IHtSZXF1ZXN0U2VydmljZX0gZnJvbSAnLi4vLi4vcmVzdC9yZXF1ZXN0JztcbmltcG9ydCB7UmVxdWVzdFRyYWNraW5nU2VydmljZX0gZnJvbSAnLi4vLi4vcmVxdWVzdHMvcmVxdWVzdC10cmFja2luZy1zdmMnO1xuaW1wb3J0IHtudW1lcmFsfSBmcm9tICcuLi8uLi9iYXNlL2xpYnMnO1xuaW1wb3J0ICogYXMgTW9kYWxIZWxwZXJzIGZyb20gJy4uLy4uL21vZGFsL21vZGFsLWhlbHBlcnMnO1xuaW1wb3J0IHtTdG9yYWdlU2l6ZX0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL3R5cGVzL3N0b3JhZ2UudHMnO1xuXG5leHBvcnQgY2xhc3MgQmxvY2tEZXZpY2VMaXN0Q29udHJvbGxlciB7XG4gICAgcHJpdmF0ZSBjbHVzdGVySWQ6IHN0cmluZztcbiAgICBwcml2YXRlIGxpc3Q6IEJsb2NrRGV2aWNlW10gPSBbXTtcbiAgICBwcml2YXRlIHRpbWVyO1xuICAgIHByaXZhdGUgY2x1c3RlcnM7XG4gICAgcHJpdmF0ZSBzaXplVW5pdHMgPSBbJ0dCJywgJ1RCJ107XG4gICAgc3RhdGljICRpbmplY3Q6IEFycmF5PHN0cmluZz4gPSBbXG4gICAgICAgICckc2NvcGUnLFxuICAgICAgICAnJGludGVydmFsJyxcbiAgICAgICAgJyRsb2NhdGlvbicsXG4gICAgICAgICckbW9kYWwnLFxuICAgICAgICAnQ2x1c3RlclNlcnZpY2UnLFxuICAgICAgICAnQmxvY2tEZXZpY2VTZXJ2aWNlJyxcbiAgICAgICAgJ1JlcXVlc3RTZXJ2aWNlJyxcbiAgICAgICAgJ1JlcXVlc3RUcmFja2luZ1NlcnZpY2UnXG4gICAgXTtcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSAkc2NvcGU6IG5nLklTY29wZSxcbiAgICAgICAgcHJpdmF0ZSAkaW50ZXJ2YWw6IG5nLklJbnRlcnZhbFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgJGxvY2F0aW9uOiBuZy5JTG9jYXRpb25TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlICRtb2RhbCxcbiAgICAgICAgcHJpdmF0ZSBjbHVzdGVyU3ZjOiBDbHVzdGVyU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBibG9ja0RldmljZVN2YzogQmxvY2tEZXZpY2VTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHJlcXVlc3RTdmM6IFJlcXVlc3RTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHJlcXVlc3RUcmFja2luZ1N2YzogUmVxdWVzdFRyYWNraW5nU2VydmljZSkge1xuICAgICAgICB0aGlzLnRpbWVyID0gdGhpcy4kaW50ZXJ2YWwoKCkgPT4gdGhpcy5yZWZyZXNoKCksIDUwMDApO1xuICAgICAgICB0aGlzLiRzY29wZS4kb24oJyRkZXN0cm95JywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy4kaW50ZXJ2YWwuY2FuY2VsKHRoaXMudGltZXIpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZWZyZXNoKCk7XG4gICAgICAgIHRoaXMuY2x1c3RlclN2Yy5nZXRMaXN0KCkudGhlbihjbHVzdGVybGlzdCA9PiB7XG4gICAgICAgICAgICB0aGlzLmNsdXN0ZXJzID0gY2x1c3Rlcmxpc3Q7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWZyZXNoKCkge1xuICAgICAgICBpZiAodGhpcy5jbHVzdGVySWQpIHtcbiAgICAgICAgICAgIHRoaXMuYmxvY2tEZXZpY2VTdmMuZ2V0TGlzdEJ5Q2x1c3Rlcih0aGlzLmNsdXN0ZXJJZCkudGhlbihibG9ja2RldmljZXMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZERhdGEoYmxvY2tkZXZpY2VzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ibG9ja0RldmljZVN2Yy5nZXRMaXN0KCkudGhlbihibG9ja2RldmljZXMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZERhdGEoYmxvY2tkZXZpY2VzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGxvYWREYXRhKGJsb2NrZGV2aWNlczogQmxvY2tEZXZpY2VbXSkge1xuICAgICAgICBfLmVhY2godGhpcy5saXN0LCAoYmxvY2tkZXZpY2UpID0+IHtcbiAgICAgICAgICAgIGJsb2NrZGV2aWNlWyd1cGRhdGVkJ10gPSBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICAgIF8uZWFjaChibG9ja2RldmljZXMsIChibG9ja2RldmljZTogQmxvY2tEZXZpY2UpID0+IHtcbiAgICAgICAgICAgIHZhciBpdGVtID0gXy5maW5kKHRoaXMubGlzdCwgaXRlbSA9PiBpdGVtLmlkID09PSBibG9ja2RldmljZS5pZCk7XG4gICAgICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgICAgIGl0ZW0uc2l6ZSA9IGJsb2NrZGV2aWNlLnNpemU7XG4gICAgICAgICAgICAgICAgaXRlbVsndXBkYXRlZCddID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGJsb2NrZGV2aWNlWyd1cGRhdGVkJ10gPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMubGlzdC5wdXNoKGJsb2NrZGV2aWNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIF8ucmVtb3ZlKHRoaXMubGlzdCwgYmxvY2tkZXZpY2UgPT4gIWJsb2NrZGV2aWNlWyd1cGRhdGVkJ10pO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRGb3JtYXRlZFNpemUoc2l6ZTogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIG51bWVyYWwoc2l6ZSkuZm9ybWF0KCcwIGInKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY3JlYXRlKCkge1xuICAgICAgICB0aGlzLiRsb2NhdGlvbi5wYXRoKCcvc3RvcmFnZS9uZXcnKS5zZWFyY2goe3R5cGU6ICdibG9jayd9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2hvd1Jlc2l6ZUZvcm0ocmJkOiBCbG9ja0RldmljZSkge1xuICAgICAgICByYmRbJ3Jlc2l6ZSddID0gdHJ1ZTtcbiAgICAgICAgdmFyIHNpemVWYWx1ZSA9IHJiZC5zaXplLnN1YnN0cmluZygwLCByYmQuc2l6ZS5sZW5ndGggLSAyKTtcbiAgICAgICAgdmFyIHNpemVVbml0ID0gcmJkLnNpemUuc3Vic3RyaW5nKHJiZC5zaXplLmxlbmd0aCAtIDIpO1xuICAgICAgICB2YXIgc2l6ZSA9IHsgdmFsdWU6IHBhcnNlSW50KHNpemVWYWx1ZSksIHVuaXQ6IHNpemVVbml0IH07XG4gICAgICAgIHJiZFsndGFyZ2V0U2l6ZSddID0gc2l6ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlU2l6ZShyYmQ6IEJsb2NrRGV2aWNlLCBuZXdTaXplOiBTdG9yYWdlU2l6ZSkge1xuICAgICAgICByYmRbJ3RhcmdldFNpemUnXSA9IG5ld1NpemU7XG4gICAgfVxuXG4gICAgcHVibGljIHJlc2l6ZShyYmQ6IEJsb2NrRGV2aWNlKSB7XG4gICAgICAgIHZhciB0YXJnZXRTaXplID0gcmJkWyd0YXJnZXRTaXplJ107XG4gICAgICAgIHZhciBzaXplID0geyBzaXplOiB0YXJnZXRTaXplLnZhbHVlLnRvU3RyaW5nKCkgKyB0YXJnZXRTaXplLnVuaXQgfTtcbiAgICAgICAgdGhpcy5ibG9ja0RldmljZVN2Yy5yZXNpemUocmJkLmNsdXN0ZXJpZCwgcmJkLnN0b3JhZ2VpZCwgcmJkLmlkLCBzaXplKS50aGVuKCh0YXNrKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RTdmMuZ2V0KHRhc2suZGF0YS50YXNraWQpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFRyYWNraW5nU3ZjLmFkZChyZXN1bHQuaWQsIHJlc3VsdC5uYW1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmJkWydyZXNpemUnXSA9IGZhbHNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBjYW5jZWxSZXNpemUocmJkOiBCbG9ja0RldmljZSkge1xuICAgICAgICByYmRbJ3Jlc2l6ZSddID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZShyYmQ6IEJsb2NrRGV2aWNlKSB7XG4gICAgICAgIHZhciBtb2RhbCA9IE1vZGFsSGVscGVycy5SZW1vdmVDb25maXJtYXRpb24odGhpcy4kbW9kYWwsIHtcbiAgICAgICAgfSk7XG4gICAgICAgIG1vZGFsLiRzY29wZS4kaGlkZSA9IF8ud3JhcChtb2RhbC4kc2NvcGUuJGhpZGUsICgkaGlkZSwgY29uZmlybWVkOiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICBpZiAoY29uZmlybWVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ibG9ja0RldmljZVN2Yy5yZW1vdmUocmJkLmNsdXN0ZXJpZCwgcmJkLnN0b3JhZ2VpZCwgcmJkLmlkKS50aGVuKCh0YXNrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFN2Yy5nZXQodGFzay5kYXRhLnRhc2tpZCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3RUcmFja2luZ1N2Yy5hZGQocmVzdWx0LmlkLCByZXN1bHQubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgJGhpZGUoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZUNsdXN0ZXIoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuJGxvY2F0aW9uLnBhdGgoJy9jbHVzdGVycy9uZXcnKTtcbiAgICB9XG59XG4iXX0=
