/// <reference path="../../../typings/tsd.d.ts" />
var idbWrapper = require('idb-wrapper');
var RequestsController = (function () {
    function RequestsController($scope, $interval, $timeout, $location, $log, $modal, serverSvc, utilSvc, eventsvc, requestSvc, sysSvc, configSvc, requestTrackingSvc, userSvc) {
        var _this = this;
        this.$scope = $scope;
        this.$interval = $interval;
        this.$timeout = $timeout;
        this.$location = $location;
        this.$log = $log;
        this.$modal = $modal;
        this.serverSvc = serverSvc;
        this.utilSvc = utilSvc;
        this.eventsvc = eventsvc;
        this.requestSvc = requestSvc;
        this.sysSvc = sysSvc;
        this.configSvc = configSvc;
        this.requestTrackingSvc = requestTrackingSvc;
        this.userSvc = userSvc;
        this.getAbout();
        this.events = [];
        this.tasks = {};
        this.discoveredHostsLength = 0;
        this.discoveredHosts = [];
        this.openWebSocket();
        this.loadEvents();
        this.$interval(function () { return _this.reloadDiscoveredHosts(); }, 12000);
        this.$interval(function () { return _this.reloadTasks(); }, 5000);
    }
    //Open WebSocket connection 
    RequestsController.prototype.openWebSocket = function () {
        var _this = this;
        if ("WebSocket" in window) {
            var ws;
            if (this.$location.protocol() === "https") {
                ws = new WebSocket("wss://" + this.$location.host() + ":8081/ws");
            }
            else {
                ws = new WebSocket("ws://" + this.$location.host() + ":8081/ws");
            }
            ws.onopen = function () {
                _this.$log.info("WebSocket Connection is Started!");
            };
            ws.onmessage = function (evt) {
                if (evt.data.length > 0) {
                    _this.events.unshift(JSON.parse(evt.data));
                    _this.events = _.filter(_this.events, function (obj) {
                        return obj["severity"] < 5;
                    });
                }
            };
            ws.onclose = function () {
                _this.$log.info("WebSocket Connection is Closed!");
                //fall back to periodic poll
                _this.$interval(function () { return _this.loadEvents(); }, 10000);
            };
        }
        else {
            this.$log.info("WebSocket is not supported by your Browser!");
            //fall back to periodic poll
            this.$interval(function () { return _this.loadEvents(); }, 10000);
        }
    };
    RequestsController.prototype.loadEvents = function () {
        var _this = this;
        this.eventsvc.getList({
            "severity": ['minor', 'warning', 'indeterminate', 'critical', 'major'],
            "acked": "false"
        }).then(function (events) {
            _this.events = _.uniq(events.events, 'event_id');
        });
    };
    RequestsController.prototype.reloadTasks = function () {
        var _this = this;
        this.requestTrackingSvc.getTrackedRequests().then(function (tasks) {
            _this.tasks = _.filter(tasks, function (task) { return !task.done; });
        });
    };
    RequestsController.prototype.viewTasks = function () {
        this.$location.path('/tasks');
    };
    RequestsController.prototype.logoutUser = function () {
        this.userSvc.logout().then(function (logout) {
            document.location.href = '';
        });
    };
    RequestsController.prototype.reloadDiscoveredHosts = function () {
        var _this = this;
        this.discoveredHosts = _.filter(this.discoveredHosts, function (host) {
            return host.state !== "ACCEPTED" && host.state !== "UNACCEPTED";
        });
        this.serverSvc.getDiscoveredHosts().then(function (freeHosts) {
            _this.discoveredHostsLength = freeHosts.length;
            _.each(freeHosts, function (freeHost) {
                var host = {
                    hostname: freeHost.hostname,
                    saltfingerprint: freeHost.saltfingerprint,
                    state: "UNACCEPTED",
                    selected: false
                };
                var isPresent = false;
                isPresent = _.some(_this.discoveredHosts, function (dHost) {
                    return dHost.hostname === host.hostname;
                });
                if (!isPresent) {
                    _this.discoveredHosts.push(host);
                }
            });
        });
    };
    RequestsController.prototype.acceptHost = function (host) {
        var _this = this;
        var saltfingerprint = {
            saltfingerprint: host.saltfingerprint
        };
        this.utilSvc.acceptHost(host.hostname, saltfingerprint).then(function (result) {
            _this.$log.info(result);
            host.state = "ACCEPTING";
            host.taskid = result.data.taskid;
            _this.requestSvc.get(host.taskid).then(function (task) {
                _this.requestTrackingSvc.add(host.taskid, task.name);
            });
            var self = _this;
            var callback = function () {
                self.requestSvc.get(host.taskid).then(function (task) {
                    if (task.completed && task.status == 1) {
                        self.$log.info('Accepted host in first controller ' + host.hostname);
                        host.state = "ACCEPTED";
                        host.task = undefined;
                    }
                    else if (task.completed && task.status == 2) {
                        self.$log.info('Failed to accept host in first controller ' + host.hostname);
                        host.state = "UNACCEPTED";
                        host.task = undefined;
                    }
                    else {
                        self.$log.info('Accepting host in first controller ' + host.hostname);
                        self.$timeout(callback, 5000);
                    }
                });
            };
            _this.$timeout(callback, 5000);
        });
    };
    RequestsController.prototype.openDiscoveredHostsModel = function () {
        this.$modal({ scope: this.$scope, template: 'views/hosts/discovered-hosts.html', show: true });
    };
    RequestsController.prototype.mySettings = function () {
        this.$modal({ scope: this.$scope, template: 'views/admin/my-settings.html', show: true });
    };
    RequestsController.prototype.openAboutModal = function () {
        this.$modal({ scope: this.$scope, template: 'views/base/about-modal.html', show: true });
    };
    RequestsController.prototype.acceptAllHosts = function () {
        var _this = this;
        _.each(this.discoveredHosts, function (host) {
            if (host.state === "UNACCEPTED") {
                _this.acceptHost(host);
            }
        });
    };
    RequestsController.prototype.getAbout = function () {
        var _this = this;
        this.sysSvc.getAboutDetails().then(function (aboutDetails) {
            _this.about = aboutDetails;
            return _this.configSvc.getConfig();
        }).then(function (config) {
            _this.about.copyright = config.copyright;
        });
    };
    RequestsController.$inject = [
        '$scope',
        '$interval',
        '$timeout',
        '$location',
        '$log',
        '$modal',
        'ServerService',
        'UtilService',
        'EventService',
        'RequestService',
        'SystemService',
        'ConfigService',
        'RequestTrackingService',
        'UserService'];
    return RequestsController;
})();
exports.RequestsController = RequestsController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvcmVxdWVzdHMvcmVxdWVzdHMtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJSZXF1ZXN0c0NvbnRyb2xsZXIiLCJSZXF1ZXN0c0NvbnRyb2xsZXIuY29uc3RydWN0b3IiLCJSZXF1ZXN0c0NvbnRyb2xsZXIub3BlbldlYlNvY2tldCIsIlJlcXVlc3RzQ29udHJvbGxlci5sb2FkRXZlbnRzIiwiUmVxdWVzdHNDb250cm9sbGVyLnJlbG9hZFRhc2tzIiwiUmVxdWVzdHNDb250cm9sbGVyLnZpZXdUYXNrcyIsIlJlcXVlc3RzQ29udHJvbGxlci5sb2dvdXRVc2VyIiwiUmVxdWVzdHNDb250cm9sbGVyLnJlbG9hZERpc2NvdmVyZWRIb3N0cyIsIlJlcXVlc3RzQ29udHJvbGxlci5hY2NlcHRIb3N0IiwiUmVxdWVzdHNDb250cm9sbGVyLm9wZW5EaXNjb3ZlcmVkSG9zdHNNb2RlbCIsIlJlcXVlc3RzQ29udHJvbGxlci5teVNldHRpbmdzIiwiUmVxdWVzdHNDb250cm9sbGVyLm9wZW5BYm91dE1vZGFsIiwiUmVxdWVzdHNDb250cm9sbGVyLmFjY2VwdEFsbEhvc3RzIiwiUmVxdWVzdHNDb250cm9sbGVyLmdldEFib3V0Il0sIm1hcHBpbmdzIjoiQUFBQSxrREFBa0Q7QUFHbEQsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBV3hDO0lBc0JJQSw0QkFBb0JBLE1BQVdBLEVBQ25CQSxTQUE4QkEsRUFDOUJBLFFBQTRCQSxFQUM1QkEsU0FBOEJBLEVBQzlCQSxJQUFvQkEsRUFDcEJBLE1BQVdBLEVBQ1hBLFNBQXdCQSxFQUN4QkEsT0FBb0JBLEVBQ3BCQSxRQUFzQkEsRUFDdEJBLFVBQTBCQSxFQUMxQkEsTUFBcUJBLEVBQ3JCQSxTQUF3QkEsRUFDeEJBLGtCQUEwQ0EsRUFDMUNBLE9BQW9CQTtRQW5DcENDLGlCQXdNQ0E7UUFsTHVCQSxXQUFNQSxHQUFOQSxNQUFNQSxDQUFLQTtRQUNuQkEsY0FBU0EsR0FBVEEsU0FBU0Es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Q3hCQSxhQUFhQSxDQUFDQSxDQUFDQTtJQW9MdkJBLHlCQUFDQTtBQUFEQSxDQXhNQSxBQXdNQ0EsSUFBQTtBQXhNWSwwQkFBa0IscUJBd005QixDQUFBIiwiZmlsZSI6Im1vZHVsZXMvcmVxdWVzdHMvcmVxdWVzdHMtY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cbmRlY2xhcmUgZnVuY3Rpb24gcmVxdWlyZShuYW1lOiBzdHJpbmcpO1xuXG52YXIgaWRiV3JhcHBlciA9IHJlcXVpcmUoJ2lkYi13cmFwcGVyJyk7XG5cbmltcG9ydCB7VXNlclNlcnZpY2V9IGZyb20gJy4uL3Jlc3QvdXNlcic7XG5pbXBvcnQge1NlcnZlclNlcnZpY2V9IGZyb20gJy4uL3Jlc3Qvc2VydmVyJztcbmltcG9ydCB7UmVxdWVzdFRyYWNraW5nU2VydmljZX0gZnJvbSAnLi9yZXF1ZXN0LXRyYWNraW5nLXN2Yyc7XG5pbXBvcnQge1V0aWxTZXJ2aWNlfSBmcm9tICcuLi9yZXN0L3V0aWwnO1xuaW1wb3J0IHtSZXF1ZXN0U2VydmljZX0gZnJvbSAnLi4vcmVzdC9yZXF1ZXN0JztcbmltcG9ydCAqIGFzIE1vZGFsSGVscGVycyBmcm9tICcuLi9tb2RhbC9tb2RhbC1oZWxwZXJzJztcbmltcG9ydCB7RXZlbnRTZXJ2aWNlfSBmcm9tICcuLi9yZXN0L2V2ZW50cyc7XG5pbXBvcnQge1N5c3RlbVNlcnZpY2V9IGZyb20gJy4uL3Jlc3Qvc3lzdGVtJztcbmltcG9ydCB7Q29uZmlnU2VydmljZX0gZnJvbSAnLi4vcmVzdC9jb25maWcnO1xuZXhwb3J0IGNsYXNzIFJlcXVlc3RzQ29udHJvbGxlciB7XG4gICAgcHJpdmF0ZSB0YXNrcztcbiAgICBwcml2YXRlIGV2ZW50czogQXJyYXk8YW55PjtcbiAgICBwcml2YXRlIGFib3V0OiBhbnk7XG4gICAgcHJpdmF0ZSBkaXNjb3ZlcmVkSG9zdHM6IEFycmF5PGFueT47XG4gICAgcHJpdmF0ZSBkaXNjb3ZlcmVkSG9zdHNMZW5ndGg6IG51bWJlcjtcbiAgICBzdGF0aWMgJGluamVjdDogQXJyYXk8c3RyaW5nPiA9IFtcbiAgICAgICAgJyRzY29wZScsXG4gICAgICAgICckaW50ZXJ2YWwnLFxuICAgICAgICAnJHRpbWVvdXQnLFxuICAgICAgICAnJGxvY2F0aW9uJyxcbiAgICAgICAgJyRsb2cnLFxuICAgICAgICAnJG1vZGFsJyxcbiAgICAgICAgJ1NlcnZlclNlcnZpY2UnLFxuICAgICAgICAnVXRpbFNlcnZpY2UnLFxuICAgICAgICAnRXZlbnRTZXJ2aWNlJyxcbiAgICAgICAgJ1JlcXVlc3RTZXJ2aWNlJyxcbiAgICAgICAgJ1N5c3RlbVNlcnZpY2UnLFxuICAgICAgICAnQ29uZmlnU2VydmljZScsXG4gICAgICAgICdSZXF1ZXN0VHJhY2tpbmdTZXJ2aWNlJyxcbiAgICAgICAgJ1VzZXJTZXJ2aWNlJ107XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlICRzY29wZTogYW55LFxuICAgICAgICBwcml2YXRlICRpbnRlcnZhbDogbmcuSUludGVydmFsU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSAkdGltZW91dDogbmcuSVRpbWVvdXRTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlICRsb2NhdGlvbjogbmcuSUxvY2F0aW9uU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSAkbG9nOiBuZy5JTG9nU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSAkbW9kYWw6IGFueSxcbiAgICAgICAgcHJpdmF0ZSBzZXJ2ZXJTdmM6IFNlcnZlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdXRpbFN2YzogVXRpbFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZXZlbnRzdmM6IEV2ZW50U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZXF1ZXN0U3ZjOiBSZXF1ZXN0U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBzeXNTdmM6IFN5c3RlbVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgY29uZmlnU3ZjOiBDb25maWdTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHJlcXVlc3RUcmFja2luZ1N2YzogUmVxdWVzdFRyYWNraW5nU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSB1c2VyU3ZjOiBVc2VyU2VydmljZSkge1xuICAgICAgICB0aGlzLmdldEFib3V0KCk7XG4gICAgICAgIHRoaXMuZXZlbnRzID0gW107XG4gICAgICAgIHRoaXMudGFza3MgPSB7fTtcbiAgICAgICAgdGhpcy5kaXNjb3ZlcmVkSG9zdHNMZW5ndGggPSAwO1xuICAgICAgICB0aGlzLmRpc2NvdmVyZWRIb3N0cyA9IFtdO1xuICAgICAgICB0aGlzLm9wZW5XZWJTb2NrZXQoKTtcbiAgICAgICAgdGhpcy5sb2FkRXZlbnRzKCk7XG4gICAgICAgIHRoaXMuJGludGVydmFsKCgpID0+IHRoaXMucmVsb2FkRGlzY292ZXJlZEhvc3RzKCksIDEyMDAwKTtcbiAgICAgICAgdGhpcy4kaW50ZXJ2YWwoKCkgPT4gdGhpcy5yZWxvYWRUYXNrcygpLCA1MDAwKTtcbiAgICB9XG5cbiAgICAvL09wZW4gV2ViU29ja2V0IGNvbm5lY3Rpb24gXG4gICAgcHVibGljIG9wZW5XZWJTb2NrZXQoKSB7XG4gICAgICAgIGlmIChcIldlYlNvY2tldFwiIGluIHdpbmRvdykge1xuICAgICAgICAgICAgdmFyIHdzO1xuICAgICAgICAgICAgaWYgKHRoaXMuJGxvY2F0aW9uLnByb3RvY29sKCkgPT09IFwiaHR0cHNcIikge1xuICAgICAgICAgICAgICAgIHdzID0gbmV3IFdlYlNvY2tldChcIndzczovL1wiICsgdGhpcy4kbG9jYXRpb24uaG9zdCgpICsgXCI6ODA4MS93c1wiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgd3MgPSBuZXcgV2ViU29ja2V0KFwid3M6Ly9cIiArIHRoaXMuJGxvY2F0aW9uLmhvc3QoKSArIFwiOjgwODEvd3NcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB3cy5vbm9wZW4gPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy4kbG9nLmluZm8oXCJXZWJTb2NrZXQgQ29ubmVjdGlvbiBpcyBTdGFydGVkIVwiKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB3cy5vbm1lc3NhZ2UgPSBldnQgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChldnQuZGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzLnVuc2hpZnQoSlNPTi5wYXJzZShldnQuZGF0YSkpO1xuICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gIF8uZmlsdGVyKHRoaXMuZXZlbnRzLCBmdW5jdGlvbihvYmope1xuICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmpbXCJzZXZlcml0eVwiXSA8IDU7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHdzLm9uY2xvc2UgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy4kbG9nLmluZm8oXCJXZWJTb2NrZXQgQ29ubmVjdGlvbiBpcyBDbG9zZWQhXCIpO1xuICAgICAgICAgICAgICAgIC8vZmFsbCBiYWNrIHRvIHBlcmlvZGljIHBvbGxcbiAgICAgICAgICAgICAgICB0aGlzLiRpbnRlcnZhbCgoKSA9PiB0aGlzLmxvYWRFdmVudHMoKSwgMTAwMDApO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuJGxvZy5pbmZvKFwiV2ViU29ja2V0IGlzIG5vdCBzdXBwb3J0ZWQgYnkgeW91ciBCcm93c2VyIVwiKTtcbiAgICAgICAgICAgIC8vZmFsbCBiYWNrIHRvIHBlcmlvZGljIHBvbGxcbiAgICAgICAgICAgIHRoaXMuJGludGVydmFsKCgpID0+IHRoaXMubG9hZEV2ZW50cygpLCAxMDAwMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZEV2ZW50cygpIHtcbiAgICAgICAgdGhpcy5ldmVudHN2Yy5nZXRMaXN0KFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIFwic2V2ZXJpdHlcIjogWydtaW5vcicsICd3YXJuaW5nJywgJ2luZGV0ZXJtaW5hdGUnLCAnY3JpdGljYWwnLCAnbWFqb3InXSxcbiAgICAgICAgICAgICAgICBcImFja2VkXCI6IFwiZmFsc2VcIlxuICAgICAgICAgICAgfSkudGhlbigoZXZlbnRzKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5ldmVudHMgPSBfLnVuaXEoZXZlbnRzLmV2ZW50cywgJ2V2ZW50X2lkJyk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVsb2FkVGFza3MoKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdFRyYWNraW5nU3ZjLmdldFRyYWNrZWRSZXF1ZXN0cygpLnRoZW4oKHRhc2tzOiBBcnJheTxhbnk+KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnRhc2tzID0gXy5maWx0ZXIodGFza3MsIHRhc2sgPT4gIXRhc2suZG9uZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyB2aWV3VGFza3MoKSB7XG4gICAgICAgIHRoaXMuJGxvY2F0aW9uLnBhdGgoJy90YXNrcycpO1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2dvdXRVc2VyKCkge1xuICAgICAgICB0aGlzLnVzZXJTdmMubG9nb3V0KCkudGhlbigobG9nb3V0KSA9PiB7XG4gICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5ocmVmID0gJyc7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWxvYWREaXNjb3ZlcmVkSG9zdHMoKSB7XG5cbiAgICAgICAgdGhpcy5kaXNjb3ZlcmVkSG9zdHMgPSBfLmZpbHRlcih0aGlzLmRpc2NvdmVyZWRIb3N0cywgKGhvc3Q6IGFueSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGhvc3Quc3RhdGUgIT09IFwiQUNDRVBURURcIiAmJiBob3N0LnN0YXRlICE9PSBcIlVOQUNDRVBURURcIjtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zZXJ2ZXJTdmMuZ2V0RGlzY292ZXJlZEhvc3RzKCkudGhlbigoZnJlZUhvc3RzKSA9PiB7XG5cbiAgICAgICAgICAgIHRoaXMuZGlzY292ZXJlZEhvc3RzTGVuZ3RoID0gZnJlZUhvc3RzLmxlbmd0aDtcblxuICAgICAgICAgICAgXy5lYWNoKGZyZWVIb3N0cywgKGZyZWVIb3N0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgaG9zdCA9IHtcbiAgICAgICAgICAgICAgICAgICAgaG9zdG5hbWU6IGZyZWVIb3N0Lmhvc3RuYW1lLFxuICAgICAgICAgICAgICAgICAgICBzYWx0ZmluZ2VycHJpbnQ6IGZyZWVIb3N0LnNhbHRmaW5nZXJwcmludCxcbiAgICAgICAgICAgICAgICAgICAgc3RhdGU6IFwiVU5BQ0NFUFRFRFwiLFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogZmFsc2VcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgdmFyIGlzUHJlc2VudCA9IGZhbHNlO1xuXG4gICAgICAgICAgICAgICAgaXNQcmVzZW50ID0gXy5zb21lKHRoaXMuZGlzY292ZXJlZEhvc3RzLCAoZEhvc3Q6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZEhvc3QuaG9zdG5hbWUgPT09IGhvc3QuaG9zdG5hbWU7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWlzUHJlc2VudCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2NvdmVyZWRIb3N0cy5wdXNoKGhvc3QpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWNjZXB0SG9zdChob3N0KSB7XG4gICAgICAgIHZhciBzYWx0ZmluZ2VycHJpbnQgPSB7XG4gICAgICAgICAgICBzYWx0ZmluZ2VycHJpbnQ6IGhvc3Quc2FsdGZpbmdlcnByaW50XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy51dGlsU3ZjLmFjY2VwdEhvc3QoaG9zdC5ob3N0bmFtZSwgc2FsdGZpbmdlcnByaW50KS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuJGxvZy5pbmZvKHJlc3VsdCk7XG4gICAgICAgICAgICBob3N0LnN0YXRlID0gXCJBQ0NFUFRJTkdcIjtcbiAgICAgICAgICAgIGhvc3QudGFza2lkID0gcmVzdWx0LmRhdGEudGFza2lkO1xuICAgICAgICAgICAgdGhpcy5yZXF1ZXN0U3ZjLmdldChob3N0LnRhc2tpZCkudGhlbigodGFzaykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFRyYWNraW5nU3ZjLmFkZChob3N0LnRhc2tpZCwgdGFzay5uYW1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5yZXF1ZXN0U3ZjLmdldChob3N0LnRhc2tpZCkudGhlbigodGFzaykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGFzay5jb21wbGV0ZWQgJiYgdGFzay5zdGF0dXMgPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi4kbG9nLmluZm8oJ0FjY2VwdGVkIGhvc3QgaW4gZmlyc3QgY29udHJvbGxlciAnICsgaG9zdC5ob3N0bmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBob3N0LnN0YXRlID0gXCJBQ0NFUFRFRFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgaG9zdC50YXNrID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRhc2suY29tcGxldGVkICYmIHRhc2suc3RhdHVzID09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuJGxvZy5pbmZvKCdGYWlsZWQgdG8gYWNjZXB0IGhvc3QgaW4gZmlyc3QgY29udHJvbGxlciAnICsgaG9zdC5ob3N0bmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBob3N0LnN0YXRlID0gXCJVTkFDQ0VQVEVEXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBob3N0LnRhc2sgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLiRsb2cuaW5mbygnQWNjZXB0aW5nIGhvc3QgaW4gZmlyc3QgY29udHJvbGxlciAnICsgaG9zdC5ob3N0bmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLiR0aW1lb3V0KGNhbGxiYWNrLCA1MDAwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy4kdGltZW91dChjYWxsYmFjaywgNTAwMCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBvcGVuRGlzY292ZXJlZEhvc3RzTW9kZWwoKSB7XG4gICAgICAgIHRoaXMuJG1vZGFsKHsgc2NvcGU6IHRoaXMuJHNjb3BlLCB0ZW1wbGF0ZTogJ3ZpZXdzL2hvc3RzL2Rpc2NvdmVyZWQtaG9zdHMuaHRtbCcsIHNob3c6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIG15U2V0dGluZ3MoKSB7XG4gICAgICAgIHRoaXMuJG1vZGFsKHsgc2NvcGU6IHRoaXMuJHNjb3BlLCB0ZW1wbGF0ZTogJ3ZpZXdzL2FkbWluL215LXNldHRpbmdzLmh0bWwnLCBzaG93OiB0cnVlIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBvcGVuQWJvdXRNb2RhbCgpIHtcbiAgICAgICAgdGhpcy4kbW9kYWwoeyBzY29wZTogdGhpcy4kc2NvcGUsIHRlbXBsYXRlOiAndmlld3MvYmFzZS9hYm91dC1tb2RhbC5odG1sJywgc2hvdzogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWNjZXB0QWxsSG9zdHMoKSB7XG4gICAgICAgIF8uZWFjaCh0aGlzLmRpc2NvdmVyZWRIb3N0cywgKGhvc3Q6IGFueSkgPT4ge1xuICAgICAgICAgICAgaWYgKGhvc3Quc3RhdGUgPT09IFwiVU5BQ0NFUFRFRFwiKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hY2NlcHRIb3N0KGhvc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0QWJvdXQoKSB7XG4gICAgICAgIHRoaXMuc3lzU3ZjLmdldEFib3V0RGV0YWlscygpLnRoZW4oKGFib3V0RGV0YWlscykgPT4ge1xuICAgICAgICAgICAgdGhpcy5hYm91dCA9IGFib3V0RGV0YWlscztcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ1N2Yy5nZXRDb25maWcoKTtcbiAgICAgICAgfSkudGhlbigoY29uZmlnKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFib3V0LmNvcHlyaWdodCA9IGNvbmZpZy5jb3B5cmlnaHQ7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==
