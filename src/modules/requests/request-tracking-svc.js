/// <reference path="../../../typings/tsd.d.ts" />
var IDBStore = require('idb-wrapper');
var RequestTrackingService = (function () {
    function RequestTrackingService($q, $log, $timeout, requestSvc, growl) {
        var _this = this;
        this.$q = $q;
        this.$log = $log;
        this.$timeout = $timeout;
        this.requestSvc = requestSvc;
        this.growl = growl;
        this.id = 0;
        this.timer = 5000;
        this.id = this.id + 1;
        this.$log.debug('Creating Request Tracking Service [' + this.id + ']');
        this.requests = new IDBStore({
            dbVersion: 1,
            storeName: 'UserRequest',
            keyPath: 'id',
            autoIncrement: false,
            onStoreReady: function () {
                _this.$log.info('UserRequest store is ready!');
                _this.timeout = $timeout(function () { return _this.processRequests(); }, _this.timer);
            },
            onError: function () {
                _this.$log.error('Unable to create UserRequest store');
            }
        });
    }
    RequestTrackingService.prototype.add = function (id, operation) {
        var _this = this;
        var d = this.$q.defer();
        if (id === null || id === undefined) {
            // resolve empty ids immediately
            d.resolve();
        }
        else {
            this.requests.put({
                id: id,
                operation: operation,
                local: true,
                timestamp: Date.now()
            }, function (id) {
                _this.$log.info('Tracking new request ' + id);
                d.resolve(id);
            }, function (error) {
                _this.$log.error('Error inserting request ' + id + ' error: ' + error);
                d.reject(error);
            });
        }
        return d.promise;
    };
    RequestTrackingService.prototype.remove = function (id) {
        var _this = this;
        var d = this.$q.defer();
        this.requests.remove(id, d.resolve, d.reject);
        d.promise.then(function (id) {
            _this.$log.info('Removed request id ' + id);
        }, function (error) {
            _this.$log.error('Error in removing request id ' + id);
        });
        return d.promise;
    };
    RequestTrackingService.prototype.getTrackedRequests = function () {
        var d = this.$q.defer();
        this.requests.getAll(d.resolve, d.reject);
        return d.promise;
    };
    RequestTrackingService.prototype.getLength = function () {
        var d = this.$q.defer();
        this.requests.count(d.resolve, d.reject);
        return d.promise;
    };
    RequestTrackingService.prototype.processRequests = function () {
        var _this = this;
        this.$log.debug('Refreshing the requests in the store');
        this.getTrackedRequests().then(function (requests) {
            _.each(requests, function (trackedRequest) {
                _this.requestSvc.get(trackedRequest.id).then(function (task) {
                    if (task.completed) {
                        if (task.status === 1) {
                            _this.showNotification(trackedRequest.operation + ' is completed sucessfully');
                            _this.$log.info(trackedRequest.operation + ' is completed sucessfully');
                        }
                        else if (task.status === 2) {
                            _this.showError(trackedRequest.operation + ' is timed out');
                            _this.$log.error(trackedRequest.operation + ' is timed out');
                        }
                        else if (task.status === 3) {
                            _this.showError(trackedRequest.operation + ' is failed');
                            _this.$log.error(trackedRequest.operation + ' is failed');
                        }
                        _this.remove(trackedRequest.id);
                    }
                    else if (!task.completed) {
                        _this.$log.info('Request ' + trackedRequest.id + ' is in progress');
                    }
                }, function (resp) {
                    if (resp.status === 404) {
                        _this.$log.warn('Request ' + trackedRequest.id + ' NOT FOUND');
                        _this.remove(trackedRequest.id);
                    }
                });
            });
        });
        this.timeout = this.$timeout(function () { return _this.processRequests(); }, this.timer);
    };
    RequestTrackingService.prototype.showError = function (msg) {
        // TODO: too tightly coupled use $broadcast
        this.growl.error('ERROR: ' + msg, {
            ttl: -1
        });
    };
    RequestTrackingService.prototype.showNotification = function (msg) {
        // TODO: too tightly coupled use $broadcast
        this.growl.success(msg);
    };
    RequestTrackingService.$inject = ['$q', '$log', '$timeout', 'RequestService', 'growl'];
    return RequestTrackingService;
})();
exports.RequestTrackingService = RequestTrackingService;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvcmVxdWVzdHMvcmVxdWVzdC10cmFja2luZy1zdmMudHMiXSwibmFtZXMiOlsiUmVxdWVzdFRyYWNraW5nU2VydmljZSIsIlJlcXVlc3RUcmFja2luZ1NlcnZpY2UuY29uc3RydWN0b3IiLCJSZXF1ZXN0VHJhY2tpbmdTZXJ2aWNlLmFkZCIsIlJlcXVlc3RUcmFja2luZ1NlcnZpY2UucmVtb3ZlIiwiUmVxdWVzdFRyYWNraW5nU2VydmljZS5nZXRUcmFja2VkUmVxdWVzdHMiLCJSZXF1ZXN0VHJhY2tpbmdTZXJ2aWNlLmdldExlbmd0aCIsIlJlcXVlc3RUcmFja2luZ1NlcnZpY2UucHJvY2Vzc1JlcXVlc3RzIiwiUmVxdWVzdFRyYWNraW5nU2VydmljZS5zaG93RXJyb3IiLCJSZXF1ZXN0VHJhY2tpbmdTZXJ2aWNlLnNob3dOb3RpZmljYXRpb24iXSwibWFwcGluZ3MiOiJBQUFBLGtEQUFrRDtBQUdsRCxJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFJdEM7SUFNSUEsZ0NBQ1lBLEVBQWdCQSxFQUNoQkEsSUFBb0JBLEVBQ3BCQSxRQUE0QkEsRUFDNUJBLFVBQTBCQSxFQUMxQkEsS0FBVUE7UUFYMUJDLGlCQXlIQ0E7UUFsSGVBLE9BQUVBLEdBQUZBLEVBQUVBLENBQWNBO1FBQ2hCQSxTQUFJQSxHQUFKQSxJQUFJQSxDQUFnQkE7UUFDcEJBLGFBQVFBLEdBQVJBLFFBQVFBLENBQW9CQTtRQUM1QkEsZUFBVUEsR0FBVkEsVUFBVUEsQ0FBZ0JBO1FBQzFCQSxVQUFLQSxHQUFMQSxLQUFLQSxDQUFLQTtRQVZkQSxPQUFFQSxHQUFXQSxDQUFDQSxDQUFDQTtRQUNmQSxVQUFLQSxHQUFXQSxJQUFJQSxDQUFDQTtRQVV6QkEsSUFBSUEsQ0FBQ0EsRUFBRUEsR0FBR0EsSUFBSUEsQ0FBQ0EsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDdEJBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLHFDQUFxQ0Es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QUFDQTtTQUNWQSxDQUFDQSxDQUFDQTtJQUNQQSxDQUFDQTtJQUVNUCxpREFBZ0JBLEdBQXZCQSxVQUF3QkEsR0FBR0E7UUFDdkJRLDJDQUEyQ0E7UUFDM0NBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO0lBQzVCQSxDQUFDQTtJQW5ITVIsOEJBQU9BLEdBQWtCQSxDQUFDQSxJQUFJQSxFQUFFQSxNQUFNQSxFQUFFQSxVQUFVQSxFQUFFQSxnQkFBZ0JBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO0lBb0gxRkEsNkJBQUNBO0FBQURBLENBekhBLEFBeUhDQSxJQUFBO0FBekhZLDhCQUFzQix5QkF5SGxDLENBQUEiLCJmaWxlIjoibW9kdWxlcy9yZXF1ZXN0cy9yZXF1ZXN0LXRyYWNraW5nLXN2Yy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cbmRlY2xhcmUgZnVuY3Rpb24gcmVxdWlyZShuYW1lOiBzdHJpbmcpO1xuXG52YXIgSURCU3RvcmUgPSByZXF1aXJlKCdpZGItd3JhcHBlcicpO1xuXG5pbXBvcnQge1JlcXVlc3RTZXJ2aWNlfSBmcm9tICcuLi9yZXN0L3JlcXVlc3QnO1xuXG5leHBvcnQgY2xhc3MgUmVxdWVzdFRyYWNraW5nU2VydmljZSB7XG4gICAgcHJpdmF0ZSBpZDogbnVtYmVyID0gMDtcbiAgICBwcml2YXRlIHRpbWVyOiBudW1iZXIgPSA1MDAwO1xuICAgIHByaXZhdGUgdGltZW91dDogYW55O1xuICAgIHByaXZhdGUgcmVxdWVzdHM6IGFueTtcbiAgICBzdGF0aWMgJGluamVjdDogQXJyYXk8c3RyaW5nPiA9IFsnJHEnLCAnJGxvZycsICckdGltZW91dCcsICdSZXF1ZXN0U2VydmljZScsICdncm93bCddO1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlICRxOiBuZy5JUVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgJGxvZzogbmcuSUxvZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgJHRpbWVvdXQ6IG5nLklUaW1lb3V0U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZXF1ZXN0U3ZjOiBSZXF1ZXN0U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBncm93bDogYW55KSB7XG4gICAgICAgIHRoaXMuaWQgPSB0aGlzLmlkICsgMTtcbiAgICAgICAgdGhpcy4kbG9nLmRlYnVnKCdDcmVhdGluZyBSZXF1ZXN0IFRyYWNraW5nIFNlcnZpY2UgWycgKyB0aGlzLmlkICsgJ10nKTtcbiAgICAgICAgdGhpcy5yZXF1ZXN0cyA9IG5ldyBJREJTdG9yZSh7XG4gICAgICAgICAgICBkYlZlcnNpb246IDEsXG4gICAgICAgICAgICBzdG9yZU5hbWU6ICdVc2VyUmVxdWVzdCcsXG4gICAgICAgICAgICBrZXlQYXRoOiAnaWQnLFxuICAgICAgICAgICAgYXV0b0luY3JlbWVudDogZmFsc2UsXG4gICAgICAgICAgICBvblN0b3JlUmVhZHk6ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLiRsb2cuaW5mbygnVXNlclJlcXVlc3Qgc3RvcmUgaXMgcmVhZHkhJyk7XG4gICAgICAgICAgICAgICAgdGhpcy50aW1lb3V0ID0gJHRpbWVvdXQoKCkgPT4gdGhpcy5wcm9jZXNzUmVxdWVzdHMoKSwgdGhpcy50aW1lcik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25FcnJvcjogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuJGxvZy5lcnJvcignVW5hYmxlIHRvIGNyZWF0ZSBVc2VyUmVxdWVzdCBzdG9yZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkKGlkLCBvcGVyYXRpb24pOiBuZy5JUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgdmFyIGQgPSB0aGlzLiRxLmRlZmVyKCk7XG4gICAgICAgIGlmIChpZCA9PT0gbnVsbCB8fCBpZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyByZXNvbHZlIGVtcHR5IGlkcyBpbW1lZGlhdGVseVxuICAgICAgICAgICAgZC5yZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RzLnB1dCh7XG4gICAgICAgICAgICAgICAgaWQ6IGlkLFxuICAgICAgICAgICAgICAgIG9wZXJhdGlvbjogb3BlcmF0aW9uLFxuICAgICAgICAgICAgICAgIGxvY2FsOiB0cnVlLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgICAgICAgICAgfSwgKGlkKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy4kbG9nLmluZm8oJ1RyYWNraW5nIG5ldyByZXF1ZXN0ICcgKyBpZCk7XG4gICAgICAgICAgICAgICAgZC5yZXNvbHZlKGlkKTtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuJGxvZy5lcnJvcignRXJyb3IgaW5zZXJ0aW5nIHJlcXVlc3QgJyArIGlkICsgJyBlcnJvcjogJyArIGVycm9yKTtcbiAgICAgICAgICAgICAgICBkLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZC5wcm9taXNlO1xuICAgIH1cblxuICAgIHB1YmxpYyByZW1vdmUoaWQpIHtcbiAgICAgICAgdmFyIGQgPSB0aGlzLiRxLmRlZmVyKCk7XG4gICAgICAgIHRoaXMucmVxdWVzdHMucmVtb3ZlKGlkLCBkLnJlc29sdmUsIGQucmVqZWN0KTtcbiAgICAgICAgZC5wcm9taXNlLnRoZW4oKGlkKSA9PiB7XG4gICAgICAgICAgICB0aGlzLiRsb2cuaW5mbygnUmVtb3ZlZCByZXF1ZXN0IGlkICcgKyBpZCk7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgdGhpcy4kbG9nLmVycm9yKCdFcnJvciBpbiByZW1vdmluZyByZXF1ZXN0IGlkICcgKyBpZCk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZC5wcm9taXNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRUcmFja2VkUmVxdWVzdHMoKSB7XG4gICAgICAgIHZhciBkID0gdGhpcy4kcS5kZWZlcigpO1xuICAgICAgICB0aGlzLnJlcXVlc3RzLmdldEFsbChkLnJlc29sdmUsIGQucmVqZWN0KTtcbiAgICAgICAgcmV0dXJuIGQucHJvbWlzZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0TGVuZ3RoKCkge1xuICAgICAgICB2YXIgZCA9IHRoaXMuJHEuZGVmZXIoKTtcbiAgICAgICAgdGhpcy5yZXF1ZXN0cy5jb3VudChkLnJlc29sdmUsIGQucmVqZWN0KTtcbiAgICAgICAgcmV0dXJuIGQucHJvbWlzZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcHJvY2Vzc1JlcXVlc3RzKCkge1xuICAgICAgICB0aGlzLiRsb2cuZGVidWcoJ1JlZnJlc2hpbmcgdGhlIHJlcXVlc3RzIGluIHRoZSBzdG9yZScpO1xuICAgICAgICB0aGlzLmdldFRyYWNrZWRSZXF1ZXN0cygpLnRoZW4oKHJlcXVlc3RzKSA9PiB7XG4gICAgICAgICAgICBfLmVhY2gocmVxdWVzdHMsICh0cmFja2VkUmVxdWVzdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0U3ZjLmdldCh0cmFja2VkUmVxdWVzdC5pZCkudGhlbigodGFzaykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGFzay5jb21wbGV0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXNrLnN0YXR1cyA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih0cmFja2VkUmVxdWVzdC5vcGVyYXRpb24gKyAnIGlzIGNvbXBsZXRlZCBzdWNlc3NmdWxseScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuJGxvZy5pbmZvKHRyYWNrZWRSZXF1ZXN0Lm9wZXJhdGlvbiArICcgaXMgY29tcGxldGVkIHN1Y2Vzc2Z1bGx5Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0YXNrLnN0YXR1cyA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Vycm9yKHRyYWNrZWRSZXF1ZXN0Lm9wZXJhdGlvbiArICcgaXMgdGltZWQgb3V0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kbG9nLmVycm9yKHRyYWNrZWRSZXF1ZXN0Lm9wZXJhdGlvbiArICcgaXMgdGltZWQgb3V0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0YXNrLnN0YXR1cyA9PT0gMykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Vycm9yKHRyYWNrZWRSZXF1ZXN0Lm9wZXJhdGlvbiArICcgaXMgZmFpbGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kbG9nLmVycm9yKHRyYWNrZWRSZXF1ZXN0Lm9wZXJhdGlvbiArICcgaXMgZmFpbGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZSh0cmFja2VkUmVxdWVzdC5pZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoIXRhc2suY29tcGxldGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLiRsb2cuaW5mbygnUmVxdWVzdCAnICsgdHJhY2tlZFJlcXVlc3QuaWQgKyAnIGlzIGluIHByb2dyZXNzJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCAocmVzcCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzcC5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy4kbG9nLndhcm4oJ1JlcXVlc3QgJyArIHRyYWNrZWRSZXF1ZXN0LmlkICsgJyBOT1QgRk9VTkQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKHRyYWNrZWRSZXF1ZXN0LmlkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudGltZW91dCA9IHRoaXMuJHRpbWVvdXQoKCkgPT4gdGhpcy5wcm9jZXNzUmVxdWVzdHMoKSwgdGhpcy50aW1lcik7XG4gICAgfVxuXG4gICAgcHVibGljIHNob3dFcnJvcihtc2cpIHtcbiAgICAgICAgLy8gVE9ETzogdG9vIHRpZ2h0bHkgY291cGxlZCB1c2UgJGJyb2FkY2FzdFxuICAgICAgICB0aGlzLmdyb3dsLmVycm9yKCdFUlJPUjogJyArIG1zZywge1xuICAgICAgICAgICAgdHRsOiAtMVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2hvd05vdGlmaWNhdGlvbihtc2cpIHtcbiAgICAgICAgLy8gVE9ETzogdG9vIHRpZ2h0bHkgY291cGxlZCB1c2UgJGJyb2FkY2FzdFxuICAgICAgICB0aGlzLmdyb3dsLnN1Y2Nlc3MobXNnKTtcbiAgICB9XG59XG4iXX0=
