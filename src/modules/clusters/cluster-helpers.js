// <reference path="../typings/tsd.d.ts" />
// <reference path="./cluster-modal.ts" />
var ClusterHelper = (function () {
    function ClusterHelper(utilService, requestService, logService, timeoutService) {
        this.utilService = utilService;
        this.requestService = requestService;
        this.logService = logService;
        this.timeoutService = timeoutService;
        //Different types of clusters.
        this.clusterTypes = [
            { ID: 1, type: 'gluster', desc: 'Gluster' },
            { ID: 2, type: 'ceph', desc: 'Ceph' }
        ];
        this.openstackServices = [
            { name: 'cinder', desc: 'Cinder (Block Volumes)' },
            { name: 'cinder-backup', desc: 'Cinder Backup (Block Volumes backup)' },
            { name: 'glance', desc: 'Glance (Images and Snapshots)' },
            { name: 'nova', desc: 'Nova (Ephemeral Storage)' },
        ];
        //This property indicates the states that a cluster can have.
        this.clusterStates = [
            { ID: 1, state: 'Inactive' },
            { ID: 2, state: 'Not Available' },
            { ID: 3, state: 'Active' },
            { ID: 4, state: 'Creating' },
            { ID: 5, state: 'Failed' }
        ];
    }
    ClusterHelper.prototype.getClusterTypes = function () {
        return this.clusterTypes;
    };
    ClusterHelper.prototype.getClusterType = function (type) {
        return _.find(this.clusterTypes, function (clusterType) {
            return clusterType.type === type;
        });
    };
    ClusterHelper.prototype.getOpenStackServices = function () {
        return this.openstackServices;
    };
    ClusterHelper.prototype.getClusterStatus = function (id) {
        return _.find(this.clusterStates, function (type) {
            return type.ID === id;
        });
    };
    ClusterHelper.prototype.callBack = function (cluster, host, result) {
        var _this = this;
        this.requestService.get(result).then(function (request) {
            if (request.status === "FAILED" || request.status === "FAILURE") {
                _this.logService.info('Failed  to accept host ' + host.hostname);
                host.state = "FAILED";
                host.task = undefined;
            }
            else if (request.status === "SUCCESS") {
                _this.logService.info('Accepted Host ' + host.hostname);
                host.state = "ACCEPTED";
                host.task = undefined;
                cluster.postAcceptHost(host);
            }
            else {
                _this.logService.info('Accepting Host ' + host.hostname);
                _this.timeoutService(function () { return _this.callBack(cluster, host, result); }, 5000);
            }
        });
    };
    /**
     * This function helps in accepting a host that already exsist.
     */
    ClusterHelper.prototype.acceptHost = function (cluster, host) {
        var _this = this;
        var saltfingerprint = {
            saltfingerprint: host.saltfingerprint
        };
        this.utilService.acceptHost(host.hostname, saltfingerprint).then(function (result) {
            _this.logService.info(result);
            host.state = "ACCEPTING";
            host.task = result;
            _this.callBack(cluster, host, result);
            _this.timeoutService(function () { return _this.callBack(cluster, host, result); }, 5000);
        });
    };
    /**
     * This function helps in accepting a new host that comes in.
     */
    ClusterHelper.prototype.acceptNewHost = function (cluster, host) {
        var hosts;
        hosts = {
            nodes: [
                {
                    "node_name": host.hostname,
                    "management_ip": host.ipaddress,
                    "ssh_username": host.username,
                    "ssh_password": host.password,
                    "ssh_key_fingerprint": host.fingerprint,
                    "ssh_port": 22
                }
            ]
        };
        // this.utilService.acceptHosts(hosts).then((result) => {
        //     this.logService.info(result);
        //     host.state = "ACCEPTING";
        //     host.task = result;
        //     this.callBack(cluster, host, result);
        //     this.timeoutService(()=>this.callBack(cluster,host,result), 5000);
        // });
    };
    /**
     * This function helps in adding a  new host with all its properties.
    */
    ClusterHelper.prototype.addNewHost = function (cluster, severService, $timeout, requestSvc) {
        var newHost = cluster.newHost;
        newHost.isVerifyingHost = true;
        newHost.errorMessage = "";
        newHost.cautionMessage = "";
        var hostObject = {
            "hostname": newHost.hostname,
            "sshfingerprint": newHost.sshfingerprint,
            "user": newHost.username,
            "password": newHost.password
        };
        //This called on success[promise].
        severService.add(hostObject).then(function (result) {
            var taskid = result.data.taskid;
            var callback = function () {
                requestSvc.get(taskid).then(function (task) {
                    if (task.completed) {
                        console.log('Added host ' + hostObject.hostname);
                        cluster.newHost = {};
                        cluster.fetchFreeHosts();
                    }
                    else {
                        console.log('Adding host ' + hostObject.hostname);
                        $timeout(callback, 5000);
                    }
                });
            };
            $timeout(callback, 5000);
        }, 
        //This a called on failure[promise].
        function () {
            cluster.newHost.errorMessage = " The username or password is incorrect.";
            cluster.newHost.isVerifyingHost = false;
        });
    };
    return ClusterHelper;
})();
exports.ClusterHelper = ClusterHelper;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvY2x1c3RlcnMvY2x1c3Rlci1oZWxwZXJzLnRzIl0sIm5hbWVzIjpbIkNsdXN0ZXJIZWxwZXIiLCJDbHVzdGVySGVscGVyLmNvbnN0cnVjdG9yIiwiQ2x1c3RlckhlbHBlci5nZXRDbHVzdGVyVHlwZXMiLCJDbHVzdGVySGVscGVyLmdldENsdXN0ZXJUeXBlIiwiQ2x1c3RlckhlbHBlci5nZXRPcGVuU3RhY2tTZXJ2aWNlcyIsIkNsdXN0ZXJIZWxwZXIuZ2V0Q2x1c3RlclN0YXR1cyIsIkNsdXN0ZXJIZWxwZXIuY2FsbEJhY2siLCJDbHVzdGVySGVscGVyLmFjY2VwdEhvc3QiLCJDbHVzdGVySGVscGVyLmFjY2VwdE5ld0hvc3QiLCJDbHVzdGVySGVscGVyLmFkZE5ld0hvc3QiXSwibWFwcGluZ3MiOiJBQUFBLDJDQUEyQztBQUMzQywwQ0FBMEM7QUFXMUM7SUFLSUEsdUJBQW9CQSxXQUF5QkEsRUFDakNBLGNBQStCQSxFQUMvQkEsVUFBMkJBLEVBQzNCQSxjQUFtQ0E7UUFIM0JDLGdCQUFXQSxHQUFYQSxXQUFXQSxDQUFjQTtRQUNqQ0EsbUJBQWNBLEdBQWRBLGNBQWNBLENBQWlCQTtRQUMvQkEsZUFBVUEsR0FBVkEsVUFBVUEsQ0FBaUJBO1FBQzNCQSxtQkFBY0EsR0FBZEEsY0FBY0EsQ0FBcUJBO1FBRTNDQSw4QkFBOEJBO1FBQzlCQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQTtZQUNoQkEsRUFBRUEsRUFBRUEsRUFBRUEsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsU0FBU0EsRUFBRUEsSUFBSUEsRUFBRUEsU0FBU0EsRUFBRUE7WUFDM0NBLEVBQUVBLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLElBQUlBLEVBQUVBLE1BQU1BLEVBQUVBLElBQUlBLEVBQUVBLE1BQU1BLEVBQUVBO1NBQ3hDQSxDQUFDQTtRQUVGQSxJQUFJQSxDQUFDQSxpQkFBaUJBLEdBQUdBO1lBQ3JCQSxFQUFFQSxJQUFJQSxFQUFFQSxRQUFRQSxFQUFFQSxJQUFJQSxF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QSxPQUFPQSxDQUFDQSxZQUFZQSxHQUFHQSx5Q0FBeUNBLENBQUNBO1lBQ3pFQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxlQUFlQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUM1Q0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7SUFDTFQsb0JBQUNBO0FBQURBLENBekpBLEFBeUpDQSxJQUFBO0FBekpZLHFCQUFhLGdCQXlKekIsQ0FBQSIsImZpbGUiOiJtb2R1bGVzL2NsdXN0ZXJzL2NsdXN0ZXItaGVscGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL3R5cGluZ3MvdHNkLmQudHNcIiAvPlxuLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi9jbHVzdGVyLW1vZGFsLnRzXCIgLz5cblxuaW1wb3J0IHtTZXJ2ZXJTZXJ2aWNlfSBmcm9tICcuLi9yZXN0L3NlcnZlcic7XG5pbXBvcnQge1JlcXVlc3RTZXJ2aWNlfSBmcm9tICcuLi9yZXN0L3JlcXVlc3QnO1xuaW1wb3J0IHtVdGlsU2VydmljZX0gZnJvbSAnLi4vcmVzdC91dGlsJztcbmltcG9ydCB7Q2x1c3RlclN0YXRlfSBmcm9tICcuL2NsdXN0ZXItbW9kYWxzJztcbmltcG9ydCB7T3BlbnN0YWNrU2VydmljZX0gZnJvbSAnLi9jbHVzdGVyLW1vZGFscyc7XG5pbXBvcnQge0tleVZhbHVlfSBmcm9tICcuL2NsdXN0ZXItbW9kYWxzJztcbmltcG9ydCB7Q2x1c3Rlcn0gZnJvbSAnLi9jbHVzdGVyLW1vZGFscyc7XG5pbXBvcnQge05vZGV9IGZyb20gJy4vY2x1c3Rlci1tb2RhbHMnO1xuXG5leHBvcnQgY2xhc3MgQ2x1c3RlckhlbHBlciAgICAgeyAgXG4gICAgcHVibGljIGNsdXN0ZXJUeXBlcyA6IEFycmF5PENsdXN0ZXI+O1xuICAgIHB1YmxpYyBvcGVuc3RhY2tTZXJ2aWNlczogQXJyYXk8T3BlbnN0YWNrU2VydmljZT47XG4gICAgcHVibGljIGNsdXN0ZXJTdGF0ZXMgOiBBcnJheTxDbHVzdGVyU3RhdGU+O1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgdXRpbFNlcnZpY2UgOiBVdGlsU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZXF1ZXN0U2VydmljZSA6IFJlcXVlc3RTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2UgOiBuZy5JTG9nU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSB0aW1lb3V0U2VydmljZSA6IG5nLklUaW1lb3V0U2VydmljZSkgICAge1xuXG4gICAgICAgIC8vRGlmZmVyZW50IHR5cGVzIG9mIGNsdXN0ZXJzLlxuICAgICAgICB0aGlzLmNsdXN0ZXJUeXBlcyA9IFtcbiAgICAgICAgICAgIHsgSUQ6IDEsIHR5cGU6ICdnbHVzdGVyJywgZGVzYzogJ0dsdXN0ZXInIH0sXG4gICAgICAgICAgICB7IElEOiAyLCB0eXBlOiAnY2VwaCcsIGRlc2M6ICdDZXBoJyB9XG4gICAgICAgIF07XG5cbiAgICAgICAgdGhpcy5vcGVuc3RhY2tTZXJ2aWNlcyA9IFtcbiAgICAgICAgICAgIHsgbmFtZTogJ2NpbmRlcicsIGRlc2M6ICdDaW5kZXIgKEJsb2NrIFZvbHVtZXMpJyB9LFxuICAgICAgICAgICAgeyBuYW1lOiAnY2luZGVyLWJhY2t1cCcsIGRlc2M6ICdDaW5kZXIgQmFja3VwIChCbG9jayBWb2x1bWVzIGJhY2t1cCknIH0sXG4gICAgICAgICAgICB7IG5hbWU6ICdnbGFuY2UnLCBkZXNjOiAnR2xhbmNlIChJbWFnZXMgYW5kIFNuYXBzaG90cyknIH0sXG4gICAgICAgICAgICB7IG5hbWU6ICdub3ZhJywgZGVzYzogJ05vdmEgKEVwaGVtZXJhbCBTdG9yYWdlKScgfSxcbiAgICAgICAgXTtcblxuICAgICAgICAvL1RoaXMgcHJvcGVydHkgaW5kaWNhdGVzIHRoZSBzdGF0ZXMgdGhhdCBhIGNsdXN0ZXIgY2FuIGhhdmUuXG4gICAgICAgIHRoaXMuY2x1c3RlclN0YXRlcyA9IFtcbiAgICAgICAgICAgIHsgSUQ6MSwgc3RhdGU6J0luYWN0aXZlJ30sXG4gICAgICAgICAgICB7IElEOjIsIHN0YXRlOidOb3QgQXZhaWxhYmxlJ30sXG4gICAgICAgICAgICB7IElEOjMsIHN0YXRlOidBY3RpdmUnfSxcbiAgICAgICAgICAgIHsgSUQ6NCwgc3RhdGU6J0NyZWF0aW5nJ30sXG4gICAgICAgICAgICB7IElEOjUsIHN0YXRlOidGYWlsZWQnfVxuICAgICAgICBdO1xuICAgIH1cblxuICAgIHB1YmxpYyAgZ2V0Q2x1c3RlclR5cGVzKCkgOiBBcnJheTxDbHVzdGVyPntcbiAgICAgICAgcmV0dXJuIHRoaXMuY2x1c3RlclR5cGVzO1xuICAgIH1cbiAgICBcbiAgICBwdWJsaWMgZ2V0Q2x1c3RlclR5cGUodHlwZTogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBfLmZpbmQodGhpcy5jbHVzdGVyVHlwZXMsIGZ1bmN0aW9uKGNsdXN0ZXJUeXBlKSB7XG4gICAgICAgICAgICByZXR1cm4gY2x1c3RlclR5cGUudHlwZSA9PT0gdHlwZTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldE9wZW5TdGFja1NlcnZpY2VzKCk6IEFycmF5PE9wZW5zdGFja1NlcnZpY2U+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3BlbnN0YWNrU2VydmljZXM7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENsdXN0ZXJTdGF0dXMoaWQgOiBudW1iZXIpICA6IENsdXN0ZXJTdGF0ZXtcbiAgICAgICAgcmV0dXJuIF8uZmluZCh0aGlzLmNsdXN0ZXJTdGF0ZXMsIGZ1bmN0aW9uKHR5cGUpIHtcbiAgICAgICAgICAgIHJldHVybiB0eXBlLklEID09PSBpZDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGNhbGxCYWNrKGNsdXN0ZXIgOmFueSwgIGhvc3QgOiBhbnksIHJlc3VsdCA6IGFueSkge1xuICAgICAgICB0aGlzLnJlcXVlc3RTZXJ2aWNlLmdldChyZXN1bHQpLnRoZW4oKHJlcXVlc3QpID0+IHtcbiAgICAgICAgICAgIGlmKHJlcXVlc3Quc3RhdHVzID09PSBcIkZBSUxFRFwiIHx8IHJlcXVlc3Quc3RhdHVzID09PSBcIkZBSUxVUkVcIikgICAge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nU2VydmljZS5pbmZvKCdGYWlsZWQgIHRvIGFjY2VwdCBob3N0ICcgKyBob3N0Lmhvc3RuYW1lKTtcbiAgICAgICAgICAgICAgICBob3N0LnN0YXRlID0gXCJGQUlMRURcIjtcbiAgICAgICAgICAgICAgICBob3N0LnRhc2sgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9IGVsc2UgaWYocmVxdWVzdC5zdGF0dXMgPT09IFwiU1VDQ0VTU1wiKSAgICB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmluZm8oJ0FjY2VwdGVkIEhvc3QgJyArIGhvc3QuaG9zdG5hbWUpO1xuICAgICAgICAgICAgICAgIGhvc3Quc3RhdGUgPSBcIkFDQ0VQVEVEXCI7XG4gICAgICAgICAgICAgICAgaG9zdC50YXNrID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICBjbHVzdGVyLnBvc3RBY2NlcHRIb3N0KGhvc3QpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuaW5mbygnQWNjZXB0aW5nIEhvc3QgJyArIGhvc3QuaG9zdG5hbWUpO1xuICAgICAgICAgICAgICAgIHRoaXMudGltZW91dFNlcnZpY2UoKCk9PnRoaXMuY2FsbEJhY2soY2x1c3Rlcixob3N0LHJlc3VsdCksIDUwMDApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogVGhpcyBmdW5jdGlvbiBoZWxwcyBpbiBhY2NlcHRpbmcgYSBob3N0IHRoYXQgYWxyZWFkeSBleHNpc3QuXG4gICAgICovXG4gICAgcHVibGljIGFjY2VwdEhvc3QoY2x1c3RlciA6IGFueSwgaG9zdCA6IGFueSkgICAge1xuICAgICAgIFxuICAgICAgICB2YXIgc2FsdGZpbmdlcnByaW50ID0ge1xuICAgICAgICAgICAgc2FsdGZpbmdlcnByaW50OiBob3N0LnNhbHRmaW5nZXJwcmludFxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgdGhpcy51dGlsU2VydmljZS5hY2NlcHRIb3N0KGhvc3QuaG9zdG5hbWUsIHNhbHRmaW5nZXJwcmludCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvZ1NlcnZpY2UuaW5mbyhyZXN1bHQpO1xuICAgICAgICAgICAgaG9zdC5zdGF0ZSA9IFwiQUNDRVBUSU5HXCI7XG4gICAgICAgICAgICBob3N0LnRhc2sgPSByZXN1bHQ7XG4gICAgICAgICAgICB0aGlzLmNhbGxCYWNrKGNsdXN0ZXIsIGhvc3QsIHJlc3VsdCk7XG4gICAgICAgICAgICB0aGlzLnRpbWVvdXRTZXJ2aWNlKCgpPT50aGlzLmNhbGxCYWNrKGNsdXN0ZXIsaG9zdCxyZXN1bHQpLCA1MDAwKTsgIFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogVGhpcyBmdW5jdGlvbiBoZWxwcyBpbiBhY2NlcHRpbmcgYSBuZXcgaG9zdCB0aGF0IGNvbWVzIGluLlxuICAgICAqL1xuICAgIHB1YmxpYyBhY2NlcHROZXdIb3N0KGNsdXN0ZXIgOiBhbnksICBob3N0IDogYW55KSAgICB7XG4gICAgICAgIHZhciBob3N0cyA6IGFueTtcbiAgICAgICAgaG9zdHMgPSB7XG4gICAgICAgICAgICBub2RlczpbXG4gICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFwibm9kZV9uYW1lXCIgOiBob3N0Lmhvc3RuYW1lLFxuICAgICAgICAgICAgICAgICAgICBcIm1hbmFnZW1lbnRfaXBcIiA6IGhvc3QuaXBhZGRyZXNzLFxuICAgICAgICAgICAgICAgICAgICBcInNzaF91c2VybmFtZVwiIDogaG9zdC51c2VybmFtZSxcbiAgICAgICAgICAgICAgICAgICAgXCJzc2hfcGFzc3dvcmRcIiA6IGhvc3QucGFzc3dvcmQsXG4gICAgICAgICAgICAgICAgICAgIFwic3NoX2tleV9maW5nZXJwcmludFwiIDogaG9zdC5maW5nZXJwcmludCxcbiAgICAgICAgICAgICAgICAgICAgXCJzc2hfcG9ydFwiIDoyMlxuICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICB9OyAgICAgXG4gICAgICAgIC8vIHRoaXMudXRpbFNlcnZpY2UuYWNjZXB0SG9zdHMoaG9zdHMpLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAvLyAgICAgdGhpcy5sb2dTZXJ2aWNlLmluZm8ocmVzdWx0KTtcbiAgICAgICAgLy8gICAgIGhvc3Quc3RhdGUgPSBcIkFDQ0VQVElOR1wiO1xuICAgICAgICAvLyAgICAgaG9zdC50YXNrID0gcmVzdWx0O1xuICAgICAgICAvLyAgICAgdGhpcy5jYWxsQmFjayhjbHVzdGVyLCBob3N0LCByZXN1bHQpO1xuICAgICAgICAvLyAgICAgdGhpcy50aW1lb3V0U2VydmljZSgoKT0+dGhpcy5jYWxsQmFjayhjbHVzdGVyLGhvc3QscmVzdWx0KSwgNTAwMCk7XG4gICAgICAgIC8vIH0pO1xuICAgIH0gICAgXG4gICAgXG4gICAgLyoqXG4gICAgICogVGhpcyBmdW5jdGlvbiBoZWxwcyBpbiBhZGRpbmcgYSAgbmV3IGhvc3Qgd2l0aCBhbGwgaXRzIHByb3BlcnRpZXMuXG4gICAgKi9cbiAgICBwdWJsaWMgYWRkTmV3SG9zdChjbHVzdGVyIDogYW55LCBzZXZlclNlcnZpY2U6IFNlcnZlclNlcnZpY2UsICR0aW1lb3V0OiBuZy5JVGltZW91dFNlcnZpY2UsIHJlcXVlc3RTdmM6IFJlcXVlc3RTZXJ2aWNlKSAgICB7XG4gICAgICAgICB2YXIgbmV3SG9zdCA9IGNsdXN0ZXIubmV3SG9zdDtcbiAgICAgICAgIG5ld0hvc3QuaXNWZXJpZnlpbmdIb3N0ID0gdHJ1ZTtcbiAgICAgICAgIG5ld0hvc3QuZXJyb3JNZXNzYWdlID0gXCJcIjsgICAgXG4gICAgICAgICBuZXdIb3N0LmNhdXRpb25NZXNzYWdlID0gXCJcIjtcbiAgICAgICAgIHZhciBob3N0T2JqZWN0ID0ge1xuICAgICAgICAgICAgIFwiaG9zdG5hbWVcIjogbmV3SG9zdC5ob3N0bmFtZSxcbiAgICAgICAgICAgICBcInNzaGZpbmdlcnByaW50XCI6IG5ld0hvc3Quc3NoZmluZ2VycHJpbnQsXG4gICAgICAgICAgICAgXCJ1c2VyXCI6IG5ld0hvc3QudXNlcm5hbWUsXG4gICAgICAgICAgICAgXCJwYXNzd29yZFwiOiBuZXdIb3N0LnBhc3N3b3JkXG4gICAgICAgICB9O1xuICAgICAgICAvL1RoaXMgY2FsbGVkIG9uIHN1Y2Nlc3NbcHJvbWlzZV0uXG4gICAgICAgIHNldmVyU2VydmljZS5hZGQoaG9zdE9iamVjdCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICB2YXIgdGFza2lkID0gcmVzdWx0LmRhdGEudGFza2lkO1xuICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdFN2Yy5nZXQodGFza2lkKS50aGVuKCh0YXNrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YXNrLmNvbXBsZXRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0FkZGVkIGhvc3QgJyArIGhvc3RPYmplY3QuaG9zdG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2x1c3Rlci5uZXdIb3N0ID0ge31cbiAgICAgICAgICAgICAgICAgICAgICAgIGNsdXN0ZXIuZmV0Y2hGcmVlSG9zdHMoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdBZGRpbmcgaG9zdCAnICsgaG9zdE9iamVjdC5ob3N0bmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dChjYWxsYmFjaywgNTAwMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICR0aW1lb3V0KGNhbGxiYWNrLCA1MDAwKTtcbiAgICAgICAgfSxcbiAgICAgICAgLy9UaGlzIGEgY2FsbGVkIG9uIGZhaWx1cmVbcHJvbWlzZV0uXG4gICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICBjbHVzdGVyLm5ld0hvc3QuZXJyb3JNZXNzYWdlID0gXCIgVGhlIHVzZXJuYW1lIG9yIHBhc3N3b3JkIGlzIGluY29ycmVjdC5cIjtcbiAgICAgICAgICAgIGNsdXN0ZXIubmV3SG9zdC5pc1ZlcmlmeWluZ0hvc3QgPSBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19
