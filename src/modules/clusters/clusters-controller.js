var clusters_1 = require('../rest/clusters');
var cluster_helpers_1 = require('./cluster-helpers');
var ClustersController = (function () {
    /**
     * Here we do the dependency injection.
    */
    function ClustersController($q, $scope, $interval, $location, $modal, volumeService, clusterSvc, storageSvc, serverService, requestSvc, requestTrackingSvc) {
        var _this = this;
        this.$q = $q;
        this.$scope = $scope;
        this.$interval = $interval;
        this.$location = $location;
        this.$modal = $modal;
        this.volumeService = volumeService;
        this.clusterSvc = clusterSvc;
        this.storageSvc = storageSvc;
        this.serverService = serverService;
        this.requestSvc = requestSvc;
        this.requestTrackingSvc = requestTrackingSvc;
        this.paramsObject = $location.search();
        if (Object.keys(this.paramsObject).length > 0) {
            this.updateSearchQuery(this.paramsObject);
        }
        this.clusterHelper = new cluster_helpers_1.ClusterHelper(null, null, null, null);
        this.timer = this.$interval(function () { return _this.refresh(); }, 10000);
        this.refresh();
        this.$scope.$on('$destroy', function () {
            _this.$interval.cancel(_this.timer);
        });
    }
    ClustersController.prototype.isArray = function (data) {
        return data instanceof Array;
    };
    ClustersController.prototype.updateSearchQuery = function (paramsObject) {
        var _this = this;
        this.searchQuery = '';
        /*  paramsObject can have 3 case : -
                1) { status: [error,warning] , tab: <OSD,HOST,etc> }
                2) { tab: <OSD,HOST,etc> }
                3) { status: [error,warning] }
            and searchQuery will be like this : -
            /api/<ver>/clusters?status=ok&status=warning&tab=<HOST/OSD/etc>
        */
        Object.keys(paramsObject).forEach(function (value) {
            var joinedStr = "";
            if (paramsObject[value] instanceof Array) {
                var queryArray = paramsObject[value].map(function (status) {
                    return value + '=' + status;
                });
                joinedStr = queryArray.join('&');
            }
            else {
                joinedStr = value + "=" + paramsObject[value];
            }
            if (_this.searchQuery !== '') {
                _this.searchQuery += "&";
            }
            _this.searchQuery += joinedStr;
        });
    };
    ClustersController.prototype.refresh = function () {
        var _this = this;
        if (this.searchQuery === '') {
            this.clusterSvc.getList().then(function (clusters) {
                _this.loadData(clusters);
            });
        }
        else {
            this.clusterSvc.getFilteredList(this.searchQuery).then(function (clusters) {
                _this.loadData(clusters);
            });
        }
    };
    ClustersController.prototype.clearSearchQuery = function (key, itemIndex) {
        if (itemIndex === null) {
            delete this.paramsObject[key];
        }
        else {
            this.paramsObject[key].splice(itemIndex, 1);
        }
        this.updateSearchQuery(this.paramsObject);
        this.refresh();
    };
    /**
     * This function helps in loading the content of the page.
    */
    ClustersController.prototype.loadData = function (clusters) {
        var _this = this;
        var tempClusters = [];
        _.each(clusters, function (cluster) {
            var tempCluster = {
                clusterid: cluster.clusterid,
                cluster_name: cluster.name,
                cluster_type: cluster.type,
                state: cluster.state,
                status: cluster.status,
                used: undefined,
                no_of_hosts: 0,
                almwarncount: cluster.almwarncount,
                almcritcount: cluster.almcritcount,
                no_of_volumes_or_pools: 0,
                trendsCharts: { title: "", data: { xData: [], yData: [] }, config: {} },
                total_size: 0,
                free_size: 0,
                percent_used: 0,
                iops: 0
            };
            if (tempCluster.used === 0) {
                tempCluster.area_spline_values = [{ '1': 0 }, { '1': 0 }];
                tempCluster.gauge_values = 0.5;
            }
            _this.clusterSvc.getIOPSById(cluster.clusterid, "-10min").then(function (iops) {
                tempCluster.iops = iops[0].datapoints[0][0];
            });
            _this.clusterSvc.getClusterSummary(cluster.clusterid).then(function (summary) {
                tempCluster.total_size = summary.usage.total;
                tempCluster.free_size = summary.usage.total - summary.usage.used;
                tempCluster.percent_used = summary.usage.percentused;
            });
            _this.serverService.getListByCluster(cluster.clusterid).then(function (nodes) {
                tempCluster.no_of_hosts = nodes.length;
            });
            _this.clusterSvc.getAlerts(cluster.clusterid).then(function (alerts) {
                tempCluster.alerts = alerts;
            });
            if (_this.getClusterTypeTitle(cluster.type) === 'gluster') {
                _this.volumeService.getListByCluster(cluster.clusterid).then(function (volumes) {
                    tempCluster.no_of_volume_or_pools = volumes.length;
                });
            }
            else {
                _this.storageSvc.getListByCluster(cluster.clusterid).then(function (pools) {
                    tempCluster.no_of_volumes_or_pools = pools.length;
                });
            }
            tempClusters.push(tempCluster);
        });
        this.clusterList = tempClusters;
    };
    /**
     * This returns the color for the gauge.
    */
    ClustersController.prototype.getClusterGaugeColor = function (gaugeValue) {
        gaugeValue = gaugeValue * 10;
        if (gaugeValue >= 90) {
            return '#CC0000';
        }
        else if (gaugeValue >= 80) {
            return '#EC7A08';
        }
        else {
            return '#3F9C35';
        }
    };
    ClustersController.prototype.getClusterTypeTitle = function (type) {
        return this.clusterHelper.getClusterType(type).type;
    };
    ClustersController.prototype.getStorageTypeTitle = function (type) {
        return this.clusterHelper.getClusterType(type).type;
    };
    ClustersController.prototype.getStatusTitle = function (type) {
        return this.clusterHelper.getClusterStatus(type).state;
    };
    ClustersController.prototype.createNewCluster = function () {
        this.$location.path('/clusters/new');
    };
    ClustersController.prototype.importCluster = function () {
        this.$location.path("/clusters/import");
    };
    ClustersController.prototype.isExpandAvailable = function (clusterState) {
        return clusterState === clusters_1.ClusterState.ACTIVE;
    };
    ClustersController.prototype.isManageAvailable = function (clusterState) {
        return clusterState === clusters_1.ClusterState.UNMANAGED;
    };
    ClustersController.prototype.isUnManageAvailable = function (clusterState) {
        return clusterState === clusters_1.ClusterState.FAILED || clusterState === clusters_1.ClusterState.ACTIVE;
    };
    ClustersController.prototype.isForgetAvailable = function (clusterState) {
        return clusterState === clusters_1.ClusterState.UNMANAGED;
    };
    /**
     * Here we change the current path to '/clusters/expand/' where the cluster can be extended
     * by adding new nodes to it.
    */
    ClustersController.prototype.expandCluster = function (clusterID, clusterState) {
        if (!this.isExpandAvailable(clusterState)) {
            return;
        }
        this.$location.path('/clusters/expand/' + clusterID);
    };
    ClustersController.prototype.enableCluster = function (clusterID, clusterState) {
        var _this = this;
        if (!this.isManageAvailable(clusterState)) {
            return;
        }
        this.clusterSvc.enable(clusterID).then(function (result) {
            _this.requestSvc.get(result.taskid).then(function (task) {
                _this.requestTrackingSvc.add(task.id, task.name);
            });
        });
    };
    ClustersController.prototype.disableCluster = function (clusterID, clusterState) {
        var _this = this;
        if (!this.isUnManageAvailable(clusterState)) {
            return;
        }
        this.clusterSvc.disable(clusterID).then(function (result) {
            _this.requestSvc.get(result.taskid).then(function (task) {
                _this.requestTrackingSvc.add(task.id, task.name);
            });
        });
    };
    /**
     * This function helps in deleting the cluster with the help
     * of clusterID.
    */
    ClustersController.prototype.removeCluster = function (clusterID, clusterState) {
        var _this = this;
        if (!this.isForgetAvailable(clusterState)) {
            return;
        }
        this.clusterSvc.remove(clusterID).then(function (result) {
            _this.requestSvc.get(result.taskid).then(function (task) {
                _this.requestTrackingSvc.add(task.id, task.name);
            });
        });
    };
    //Services that are used in this class.
    ClustersController.$inject = [
        '$q',
        '$scope',
        '$interval',
        '$location',
        '$modal',
        'VolumeService',
        'ClusterService',
        'StorageService',
        'ServerService',
        'RequestService',
        'RequestTrackingService'
    ];
    return ClustersController;
})();
exports.ClustersController = ClustersController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvY2x1c3RlcnMvY2x1c3RlcnMtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJDbHVzdGVyc0NvbnRyb2xsZXIiLCJDbHVzdGVyc0NvbnRyb2xsZXIuY29uc3RydWN0b3IiLCJDbHVzdGVyc0NvbnRyb2xsZXIuaXNBcnJheSIsIkNsdXN0ZXJzQ29udHJvbGxlci51cGRhdGVTZWFyY2hRdWVyeSIsIkNsdXN0ZXJzQ29udHJvbGxlci5yZWZyZXNoIiwiQ2x1c3RlcnNDb250cm9sbGVyLmNsZWFyU2VhcmNoUXVlcnkiLCJDbHVzdGVyc0NvbnRyb2xsZXIubG9hZERhdGEiLCJDbHVzdGVyc0NvbnRyb2xsZXIuZ2V0Q2x1c3RlckdhdWdlQ29sb3IiLCJDbHVzdGVyc0NvbnRyb2xsZXIuZ2V0Q2x1c3RlclR5cGVUaXRsZSIsIkNsdXN0ZXJzQ29udHJvbGxlci5nZXRTdG9yYWdlVHlwZVRpdGxlIiwiQ2x1c3RlcnNDb250cm9sbGVyLmdldFN0YXR1c1RpdGxlIiwiQ2x1c3RlcnNDb250cm9sbGVyLmNyZWF0ZU5ld0NsdXN0ZXIiLCJDbHVzdGVyc0NvbnRyb2xsZXIuaW1wb3J0Q2x1c3RlciIsIkNsdXN0ZXJzQ29udHJvbGxlci5pc0V4cGFuZEF2YWlsYWJsZSIsIkNsdXN0ZXJzQ29udHJvbGxlci5pc01hbmFnZUF2YWlsYWJsZSIsIkNsdXN0ZXJzQ29udHJvbGxlci5pc1VuTWFuYWdlQXZhaWxhYmxlIiwiQ2x1c3RlcnNDb250cm9sbGVyLmlzRm9yZ2V0QXZhaWxhYmxlIiwiQ2x1c3RlcnNDb250cm9sbGVyLmV4cGFuZENsdXN0ZXIiLCJDbHVzdGVyc0NvbnRyb2xsZXIuZW5hYmxlQ2x1c3RlciIsIkNsdXN0ZXJzQ29udHJvbGxlci5kaXNhYmxlQ2x1c3RlciIsIkNsdXN0ZXJzQ29udHJvbGxlci5yZW1vdmVDbHVzdGVyIl0sIm1hcHBpbmdzIjoiQUFFQSx5QkFBMkIsa0JBQWtCLENBQUMsQ0FBQTtBQUU5QyxnQ0FBNEIsbUJBQW1CLENBQUMsQ0FBQTtB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QTtRQUNKQSxRQUFRQTtRQUNSQSxXQUFXQTtRQUNYQSxXQUFXQTtRQUNYQSxRQUFRQTtRQUNSQSxlQUFlQTtRQUNmQSxnQkFBZ0JBO1FBQ2hCQSxnQkFBZ0JBO1FBQ2hCQSxlQUFlQTtRQUNmQSxnQkFBZ0JBO1FBQ2hCQSx3QkFBd0JBO0tBQzNCQSxDQUFDQTtJQW1QTkEseUJBQUNBO0FBQURBLENBdFFBLEFBc1FDQSxJQUFBO0FBdFFZLDBCQUFrQixxQkFzUTlCLENBQUEiLCJmaWxlIjoibW9kdWxlcy9jbHVzdGVycy9jbHVzdGVycy1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQge0NsdXN0ZXJ9IGZyb20gJy4uL3Jlc3QvY2x1c3RlcnMnO1xuaW1wb3J0IHtDbHVzdGVyU3RhdGV9IGZyb20gJy4uL3Jlc3QvY2x1c3RlcnMnO1xuaW1wb3J0IHtDbHVzdGVyU2VydmljZX0gZnJvbSAnLi4vcmVzdC9jbHVzdGVycyc7XG5pbXBvcnQge0NsdXN0ZXJIZWxwZXJ9IGZyb20gJy4vY2x1c3Rlci1oZWxwZXJzJztcbmltcG9ydCB7Vm9sdW1lU2VydmljZX0gZnJvbSAnLi4vcmVzdC92b2x1bWUnO1xuaW1wb3J0IHtTdG9yYWdlU2VydmljZX0gZnJvbSAnLi4vcmVzdC9zdG9yYWdlJztcbmltcG9ydCB7U2VydmVyU2VydmljZX0gZnJvbSAnLi4vcmVzdC9zZXJ2ZXInO1xuaW1wb3J0IHtSZXF1ZXN0U2VydmljZX0gZnJvbSAnLi4vcmVzdC9yZXF1ZXN0JztcbmltcG9ydCB7UmVxdWVzdFRyYWNraW5nU2VydmljZX0gZnJvbSAnLi4vcmVxdWVzdHMvcmVxdWVzdC10cmFja2luZy1zdmMnO1xuaW1wb3J0ICogYXMgTW9kYWxIZWxwZXJzIGZyb20gJy4uL21vZGFsL21vZGFsLWhlbHBlcnMnO1xuXG5leHBvcnQgY2xhc3MgQ2x1c3RlcnNDb250cm9sbGVyIHtcbiAgICBwdWJsaWMgY2x1c3Rlckxpc3Q6IEFycmF5PGFueT47XG4gICAgcHJpdmF0ZSBjbHVzdGVySGVscGVyOiBDbHVzdGVySGVscGVyO1xuICAgIHByaXZhdGUgc2VhcmNoUXVlcnk6IHN0cmluZztcbiAgICBwcml2YXRlIHBhcmFtc09iamVjdDogYW55O1xuXG4gICAgLy9TZXJ2aWNlcyB0aGF0IGFyZSB1c2VkIGluIHRoaXMgY2xhc3MuXG4gICAgc3RhdGljICRpbmplY3Q6IEFycmF5PHN0cmluZz4gPSBbXG4gICAgICAgICckcScsXG4gICAgICAgICckc2NvcGUnLFxuICAgICAgICAnJGludGVydmFsJyxcbiAgICAgICAgJyRsb2NhdGlvbicsXG4gICAgICAgICckbW9kYWwnLFxuICAgICAgICAnVm9sdW1lU2VydmljZScsXG4gICAgICAgICdDbHVzdGVyU2VydmljZScsXG4gICAgICAgICdTdG9yYWdlU2VydmljZScsXG4gICAgICAgICdTZXJ2ZXJTZXJ2aWNlJyxcbiAgICAgICAgJ1JlcXVlc3RTZXJ2aWNlJyxcbiAgICAgICAgJ1JlcXVlc3RUcmFja2luZ1NlcnZpY2UnXG4gICAgXTtcblxuICAgIC8vVGltZXIgdG8gcmVmcmVzaCB0aGUgZGF0YSBldmVyeSAxMCBzZWNvbmRzXG4gICAgcHJpdmF0ZSB0aW1lcjtcblxuICAgIC8qKlxuICAgICAqIEhlcmUgd2UgZG8gdGhlIGRlcGVuZGVuY3kgaW5qZWN0aW9uLlxuICAgICovXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSAkcTogbmcuSVFTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlICRzY29wZTogbmcuSVNjb3BlLFxuICAgICAgICBwcml2YXRlICRpbnRlcnZhbDogbmcuSUludGVydmFsU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSAkbG9jYXRpb246IG5nLklMb2NhdGlvblNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgJG1vZGFsLFxuICAgICAgICBwcml2YXRlIHZvbHVtZVNlcnZpY2U6IFZvbHVtZVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgY2x1c3RlclN2YzogQ2x1c3RlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgc3RvcmFnZVN2YzogU3RvcmFnZVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgc2VydmVyU2VydmljZTogU2VydmVyU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZXF1ZXN0U3ZjOiBSZXF1ZXN0U2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZXF1ZXN0VHJhY2tpbmdTdmM6IFJlcXVlc3RUcmFja2luZ1NlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5wYXJhbXNPYmplY3QgPSAkbG9jYXRpb24uc2VhcmNoKCk7XG4gICAgICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLnBhcmFtc09iamVjdCkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTZWFyY2hRdWVyeSh0aGlzLnBhcmFtc09iamVjdCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jbHVzdGVySGVscGVyID0gbmV3IENsdXN0ZXJIZWxwZXIobnVsbCwgbnVsbCwgbnVsbCwgbnVsbCk7XG4gICAgICAgIHRoaXMudGltZXIgPSB0aGlzLiRpbnRlcnZhbCgoKSA9PiB0aGlzLnJlZnJlc2goKSwgMTAwMDApO1xuICAgICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICAgICAgdGhpcy4kc2NvcGUuJG9uKCckZGVzdHJveScsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuJGludGVydmFsLmNhbmNlbCh0aGlzLnRpbWVyKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGlzQXJyYXkoZGF0YSk6IEJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZGF0YSBpbnN0YW5jZW9mIEFycmF5O1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVTZWFyY2hRdWVyeShwYXJhbXNPYmplY3Q6IGFueSkge1xuICAgICAgICB0aGlzLnNlYXJjaFF1ZXJ5ID0gJyc7XG4gICAgICAgIC8qICBwYXJhbXNPYmplY3QgY2FuIGhhdmUgMyBjYXNlIDogLVxuICAgICAgICAgICAgICAgIDEpIHsgc3RhdHVzOiBbZXJyb3Isd2FybmluZ10gLCB0YWI6IDxPU0QsSE9TVCxldGM+IH1cbiAgICAgICAgICAgICAgICAyKSB7IHRhYjogPE9TRCxIT1NULGV0Yz4gfVxuICAgICAgICAgICAgICAgIDMpIHsgc3RhdHVzOiBbZXJyb3Isd2FybmluZ10gfVxuICAgICAgICAgICAgYW5kIHNlYXJjaFF1ZXJ5IHdpbGwgYmUgbGlrZSB0aGlzIDogLVxuICAgICAgICAgICAgL2FwaS88dmVyPi9jbHVzdGVycz9zdGF0dXM9b2smc3RhdHVzPXdhcm5pbmcmdGFiPTxIT1NUL09TRC9ldGM+XG4gICAgICAgICovXG4gICAgICAgIE9iamVjdC5rZXlzKHBhcmFtc09iamVjdCkuZm9yRWFjaCgodmFsdWU6IGFueSkgPT4ge1xuICAgICAgICAgICAgbGV0IGpvaW5lZFN0ciA9IFwiXCI7XG4gICAgICAgICAgICBpZihwYXJhbXNPYmplY3RbdmFsdWVdIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgICAgICB2YXIgcXVlcnlBcnJheSA9IHBhcmFtc09iamVjdFt2YWx1ZV0ubWFwKGZ1bmN0aW9uKHN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICsgJz0nICsgc3RhdHVzO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgam9pbmVkU3RyID0gcXVlcnlBcnJheS5qb2luKCcmJyk7XG4gICAgICAgICAgICB9ZWxzZSB7XG4gICAgICAgICAgICAgICAgam9pbmVkU3RyID0gdmFsdWUgKyBcIj1cIiArIHBhcmFtc09iamVjdFt2YWx1ZV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIHRoaXMuc2VhcmNoUXVlcnkgIT09ICcnICkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoUXVlcnkgKz0gXCImXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2VhcmNoUXVlcnkgKz0gam9pbmVkU3RyO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVmcmVzaCgpIHtcbiAgICAgICAgaWYodGhpcy5zZWFyY2hRdWVyeSA9PT0gJycpIHtcbiAgICAgICAgICAgIHRoaXMuY2x1c3RlclN2Yy5nZXRMaXN0KCkudGhlbigoY2x1c3RlcnM6IENsdXN0ZXJbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZERhdGEoY2x1c3RlcnMpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1lbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2x1c3RlclN2Yy5nZXRGaWx0ZXJlZExpc3QodGhpcy5zZWFyY2hRdWVyeSkudGhlbigoY2x1c3RlcnM6IENsdXN0ZXJbXSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZERhdGEoY2x1c3RlcnMpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgY2xlYXJTZWFyY2hRdWVyeShrZXksIGl0ZW1JbmRleCkge1xuICAgICAgICBpZihpdGVtSW5kZXggPT09IG51bGwpIHtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnBhcmFtc09iamVjdFtrZXldO1xuICAgICAgICB9ZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnBhcmFtc09iamVjdFtrZXldLnNwbGljZShpdGVtSW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudXBkYXRlU2VhcmNoUXVlcnkodGhpcy5wYXJhbXNPYmplY3QpO1xuICAgICAgICB0aGlzLnJlZnJlc2goKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZ1bmN0aW9uIGhlbHBzIGluIGxvYWRpbmcgdGhlIGNvbnRlbnQgb2YgdGhlIHBhZ2UuXG4gICAgKi9cbiAgICBwdWJsaWMgbG9hZERhdGEoY2x1c3RlcnM6IENsdXN0ZXJbXSkge1xuICAgICAgICB2YXIgdGVtcENsdXN0ZXJzOiBBcnJheTxhbnk+ID0gW107XG4gICAgICAgIF8uZWFjaChjbHVzdGVycywgKGNsdXN0ZXIpID0+IHtcbiAgICAgICAgICAgIHZhciB0ZW1wQ2x1c3RlcjogYW55ID0ge1xuICAgICAgICAgICAgICAgIGNsdXN0ZXJpZDogY2x1c3Rlci5jbHVzdGVyaWQsXG4gICAgICAgICAgICAgICAgY2x1c3Rlcl9uYW1lOiBjbHVzdGVyLm5hbWUsXG4gICAgICAgICAgICAgICAgY2x1c3Rlcl90eXBlOiBjbHVzdGVyLnR5cGUsXG4gICAgICAgICAgICAgICAgc3RhdGU6IGNsdXN0ZXIuc3RhdGUsXG4gICAgICAgICAgICAgICAgc3RhdHVzOiBjbHVzdGVyLnN0YXR1cyxcbiAgICAgICAgICAgICAgICB1c2VkOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgbm9fb2ZfaG9zdHM6IDAsXG4gICAgICAgICAgICAgICAgYWxtd2FybmNvdW50OiBjbHVzdGVyLmFsbXdhcm5jb3VudCxcbiAgICAgICAgICAgICAgICBhbG1jcml0Y291bnQ6IGNsdXN0ZXIuYWxtY3JpdGNvdW50LFxuICAgICAgICAgICAgICAgIG5vX29mX3ZvbHVtZXNfb3JfcG9vbHM6IDAsXG4gICAgICAgICAgICAgICAgdHJlbmRzQ2hhcnRzIDoge3RpdGxlOlwiXCIsZGF0YTp7eERhdGE6W10seURhdGE6W119LGNvbmZpZzp7fX0sXG4gICAgICAgICAgICAgICAgdG90YWxfc2l6ZTogMCxcbiAgICAgICAgICAgICAgICBmcmVlX3NpemU6IDAsXG4gICAgICAgICAgICAgICAgcGVyY2VudF91c2VkOiAwLFxuICAgICAgICAgICAgICAgIGlvcHM6MFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKHRlbXBDbHVzdGVyLnVzZWQgPT09IDApIHtcbiAgICAgICAgICAgICAgICB0ZW1wQ2x1c3Rlci5hcmVhX3NwbGluZV92YWx1ZXMgPSBbeyAnMSc6IDAgfSwgeyAnMSc6IDAgfV07XG4gICAgICAgICAgICAgICAgdGVtcENsdXN0ZXIuZ2F1Z2VfdmFsdWVzID0gMC41O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmNsdXN0ZXJTdmMuZ2V0SU9QU0J5SWQoY2x1c3Rlci5jbHVzdGVyaWQsIFwiLTEwbWluXCIpLnRoZW4oKGlvcHMpID0+IHtcbiAgICAgICAgICAgICAgICB0ZW1wQ2x1c3Rlci5pb3BzID0gaW9wc1swXS5kYXRhcG9pbnRzWzBdWzBdO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuY2x1c3RlclN2Yy5nZXRDbHVzdGVyU3VtbWFyeShjbHVzdGVyLmNsdXN0ZXJpZCkudGhlbigoc3VtbWFyeSkgPT4ge1xuICAgICAgICAgICAgICAgIHRlbXBDbHVzdGVyLnRvdGFsX3NpemUgPSBzdW1tYXJ5LnVzYWdlLnRvdGFsO1xuICAgICAgICAgICAgICAgIHRlbXBDbHVzdGVyLmZyZWVfc2l6ZSA9IHN1bW1hcnkudXNhZ2UudG90YWwgLSBzdW1tYXJ5LnVzYWdlLnVzZWQ7XG4gICAgICAgICAgICAgICAgdGVtcENsdXN0ZXIucGVyY2VudF91c2VkID0gc3VtbWFyeS51c2FnZS5wZXJjZW50dXNlZDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLnNlcnZlclNlcnZpY2UuZ2V0TGlzdEJ5Q2x1c3RlcihjbHVzdGVyLmNsdXN0ZXJpZCkudGhlbigobm9kZXMpID0+IHtcbiAgICAgICAgICAgICAgICB0ZW1wQ2x1c3Rlci5ub19vZl9ob3N0cyA9IG5vZGVzLmxlbmd0aDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLmNsdXN0ZXJTdmMuZ2V0QWxlcnRzKGNsdXN0ZXIuY2x1c3RlcmlkKS50aGVuKChhbGVydHMpID0+IHtcbiAgICAgICAgICAgICAgICB0ZW1wQ2x1c3Rlci5hbGVydHMgPSBhbGVydHM7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuZ2V0Q2x1c3RlclR5cGVUaXRsZShjbHVzdGVyLnR5cGUpID09PSAnZ2x1c3RlcicpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnZvbHVtZVNlcnZpY2UuZ2V0TGlzdEJ5Q2x1c3RlcihjbHVzdGVyLmNsdXN0ZXJpZCkudGhlbigodm9sdW1lcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0ZW1wQ2x1c3Rlci5ub19vZl92b2x1bWVfb3JfcG9vbHMgPSB2b2x1bWVzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcmFnZVN2Yy5nZXRMaXN0QnlDbHVzdGVyKGNsdXN0ZXIuY2x1c3RlcmlkKS50aGVuKGZ1bmN0aW9uKHBvb2xzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRlbXBDbHVzdGVyLm5vX29mX3ZvbHVtZXNfb3JfcG9vbHMgPSBwb29scy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRlbXBDbHVzdGVycy5wdXNoKHRlbXBDbHVzdGVyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY2x1c3Rlckxpc3QgPSB0ZW1wQ2x1c3RlcnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyByZXR1cm5zIHRoZSBjb2xvciBmb3IgdGhlIGdhdWdlLlxuICAgICovXG4gICAgcHVibGljIGdldENsdXN0ZXJHYXVnZUNvbG9yKGdhdWdlVmFsdWU6IG51bWJlcik6IHN0cmluZyB7XG4gICAgICAgIGdhdWdlVmFsdWUgPSBnYXVnZVZhbHVlICogMTA7XG4gICAgICAgIGlmIChnYXVnZVZhbHVlID49IDkwKSB7XG4gICAgICAgICAgICByZXR1cm4gJyNDQzAwMDAnO1xuICAgICAgICB9IGVsc2UgaWYgKGdhdWdlVmFsdWUgPj0gODApIHtcbiAgICAgICAgICAgIHJldHVybiAnI0VDN0EwOCc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gJyMzRjlDMzUnO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGdldENsdXN0ZXJUeXBlVGl0bGUodHlwZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2x1c3RlckhlbHBlci5nZXRDbHVzdGVyVHlwZSh0eXBlKS50eXBlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRTdG9yYWdlVHlwZVRpdGxlKHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNsdXN0ZXJIZWxwZXIuZ2V0Q2x1c3RlclR5cGUodHlwZSkudHlwZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0U3RhdHVzVGl0bGUodHlwZTogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2x1c3RlckhlbHBlci5nZXRDbHVzdGVyU3RhdHVzKHR5cGUpLnN0YXRlO1xuICAgIH1cblxuICAgIHB1YmxpYyBjcmVhdGVOZXdDbHVzdGVyKCk6IHZvaWQge1xuICAgICAgICAgICAgICAgIHRoaXMuJGxvY2F0aW9uLnBhdGgoJy9jbHVzdGVycy9uZXcnKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW1wb3J0Q2x1c3RlcigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy4kbG9jYXRpb24ucGF0aChcIi9jbHVzdGVycy9pbXBvcnRcIik7XG4gICAgfVxuXG4gICAgcHVibGljIGlzRXhwYW5kQXZhaWxhYmxlKGNsdXN0ZXJTdGF0ZTogQ2x1c3RlclN0YXRlKSB7XG4gICAgICAgIHJldHVybiBjbHVzdGVyU3RhdGUgPT09IENsdXN0ZXJTdGF0ZS5BQ1RJVkU7XG4gICAgfVxuXG4gICAgcHVibGljIGlzTWFuYWdlQXZhaWxhYmxlKGNsdXN0ZXJTdGF0ZTogQ2x1c3RlclN0YXRlKSB7XG4gICAgICAgIHJldHVybiBjbHVzdGVyU3RhdGUgPT09IENsdXN0ZXJTdGF0ZS5VTk1BTkFHRUQ7XG4gICAgfVxuXG4gICAgcHVibGljIGlzVW5NYW5hZ2VBdmFpbGFibGUoY2x1c3RlclN0YXRlOiBDbHVzdGVyU3RhdGUpIHtcbiAgICAgICAgcmV0dXJuIGNsdXN0ZXJTdGF0ZSA9PT0gQ2x1c3RlclN0YXRlLkZBSUxFRCB8fCBjbHVzdGVyU3RhdGUgPT09IENsdXN0ZXJTdGF0ZS5BQ1RJVkU7XG4gICAgfVxuXG4gICAgcHVibGljIGlzRm9yZ2V0QXZhaWxhYmxlKGNsdXN0ZXJTdGF0ZTogQ2x1c3RlclN0YXRlKSB7XG4gICAgICAgIHJldHVybiBjbHVzdGVyU3RhdGUgPT09IENsdXN0ZXJTdGF0ZS5VTk1BTkFHRUQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGVyZSB3ZSBjaGFuZ2UgdGhlIGN1cnJlbnQgcGF0aCB0byAnL2NsdXN0ZXJzL2V4cGFuZC8nIHdoZXJlIHRoZSBjbHVzdGVyIGNhbiBiZSBleHRlbmRlZFxuICAgICAqIGJ5IGFkZGluZyBuZXcgbm9kZXMgdG8gaXQuXG4gICAgKi9cbiAgICBwdWJsaWMgZXhwYW5kQ2x1c3RlcihjbHVzdGVySUQ6IHN0cmluZywgY2x1c3RlclN0YXRlOiBDbHVzdGVyU3RhdGUpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzRXhwYW5kQXZhaWxhYmxlKGNsdXN0ZXJTdGF0ZSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLiRsb2NhdGlvbi5wYXRoKCcvY2x1c3RlcnMvZXhwYW5kLycgKyBjbHVzdGVySUQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBlbmFibGVDbHVzdGVyKGNsdXN0ZXJJRDogc3RyaW5nLCBjbHVzdGVyU3RhdGU6IENsdXN0ZXJTdGF0ZSk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuaXNNYW5hZ2VBdmFpbGFibGUoY2x1c3RlclN0YXRlKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2x1c3RlclN2Yy5lbmFibGUoY2x1c3RlcklEKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVxdWVzdFN2Yy5nZXQocmVzdWx0LnRhc2tpZCkudGhlbigodGFzaykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFRyYWNraW5nU3ZjLmFkZCh0YXNrLmlkLCB0YXNrLm5hbWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBkaXNhYmxlQ2x1c3RlcihjbHVzdGVySUQ6IHN0cmluZywgY2x1c3RlclN0YXRlOiBDbHVzdGVyU3RhdGUpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzVW5NYW5hZ2VBdmFpbGFibGUoY2x1c3RlclN0YXRlKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2x1c3RlclN2Yy5kaXNhYmxlKGNsdXN0ZXJJRCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RTdmMuZ2V0KHJlc3VsdC50YXNraWQpLnRoZW4oKHRhc2spID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3RUcmFja2luZ1N2Yy5hZGQodGFzay5pZCwgdGFzay5uYW1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZ1bmN0aW9uIGhlbHBzIGluIGRlbGV0aW5nIHRoZSBjbHVzdGVyIHdpdGggdGhlIGhlbHBcbiAgICAgKiBvZiBjbHVzdGVySUQuXG4gICAgKi9cbiAgICBwdWJsaWMgcmVtb3ZlQ2x1c3RlcihjbHVzdGVySUQ6IHN0cmluZywgY2x1c3RlclN0YXRlOiBDbHVzdGVyU3RhdGUpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzRm9yZ2V0QXZhaWxhYmxlKGNsdXN0ZXJTdGF0ZSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsdXN0ZXJTdmMucmVtb3ZlKGNsdXN0ZXJJRCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlcXVlc3RTdmMuZ2V0KHJlc3VsdC50YXNraWQpLnRoZW4oKHRhc2spID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3RUcmFja2luZ1N2Yy5hZGQodGFzay5pZCwgdGFzay5uYW1lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=
