// <reference path="../typings/tsd.d.ts" />
var ModalHelper = require('../../modal/modal-helpers');
var ImportClusterController = (function () {
    function ImportClusterController(logService, modalService, $location, clusterService, requestService, requestTrackingService, serverService) {
        this.logService = logService;
        this.modalService = modalService;
        this.$location = $location;
        this.clusterService = clusterService;
        this.requestService = requestService;
        this.requestTrackingService = requestTrackingService;
        this.serverService = serverService;
        this.loadAllFreeHosts();
        this.step = 1;
    }
    ImportClusterController.prototype.loadAllFreeHosts = function () {
        var _this = this;
        this.serverService.getAllFreeHosts().then(function (freeHosts) {
            _this.freeHosts = freeHosts;
        });
    };
    ImportClusterController.prototype.loadClusterDetails = function () {
        var _this = this;
        this.error = undefined;
        this.clusterService.getImportClusterDeatils(this.bootstrapNode.hostname).then(function (result) {
            if (result.status === 200) {
                _this.clusterSummary = result.data;
                _this.step = 2;
                if (!_this.clusterSummary.compatible) {
                    _this.error = "Cluster with version '" + _this.clusterSummary.version + "' is not compatible . Please ensure that Ceph 2.0 or greater is installed.";
                }
                else if (!_this.isAllHostsFound(_this.clusterSummary)) {
                    _this.error = "One or more of the hosts in this cluster cannot be found. Please ensure that Ceph 2.0 or greater is installed on this host and that it is available on the network. Click Refresh to search for this host again.";
                }
            }
            else {
                _this.error = "Failed to retrive cluster information from the selected host '" + _this.bootstrapNode.hostname + "'. Please select a monitor host and try again";
            }
        }, function (error) {
            _this.error = "Failed to retrive cluster information from the selected host '" + _this.bootstrapNode.hostname + "'. Please select a monitor host and try again";
        });
    };
    ImportClusterController.prototype.isAllHostsFound = function (clusterSummary) {
        return _.every(clusterSummary.nodes, function (node) { return node.found; });
    };
    ImportClusterController.prototype.import = function () {
        var _this = this;
        var nodes = _.map(this.clusterSummary.nodes, function (node) { return node.name; });
        var cluster = { 'bootstrapnode': this.bootstrapNode.hostname, 'type': 'ceph', 'nodes': nodes };
        this.clusterService.importCephCluster(cluster).then(function (result) {
            if (result.status === 202) {
                _this.requestService.get(result.data.taskid).then(function (task) {
                    _this.requestTrackingService.add(task.id, task.name);
                });
                var modal = ModalHelper.SuccessfulRequest(_this.modalService, {
                    title: 'Import Cluster request is being processed',
                    container: '.usmClientApp'
                });
                modal.$scope.$hide = _.wrap(modal.$scope.$hide, function ($hide) {
                    $hide();
                    _this.$location.path('/tasks/' + result.data.taskid);
                });
            }
            else {
                _this.logService.error('Failed to import the cluster:', result);
            }
        });
    };
    ImportClusterController.prototype.cancel = function () {
        this.$location.path('/clusters');
    };
    ImportClusterController.prototype.selectHost = function (host) {
        this.bootstrapNode = host;
    };
    ImportClusterController.$inject = ['$log', '$modal', '$location', 'ClusterService', 'RequestService', 'RequestTrackingService', 'ServerService'];
    return ImportClusterController;
})();
exports.ImportClusterController = ImportClusterController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvY2x1c3RlcnMvaW1wb3J0LWNsdXN0ZXIvaW1wb3J0LWNsdXN0ZXIudHMiXSwibmFtZXMiOlsiSW1wb3J0Q2x1c3RlckNvbnRyb2xsZXIiLCJJbXBvcnRDbHVzdGVyQ29udHJvbGxlci5jb25zdHJ1Y3RvciIsIkltcG9ydENsdXN0ZXJDb250cm9sbGVyLmxvYWRBbGxGcmVlSG9zdHMiLCJJbXBvcnRDbHVzdGVyQ29udHJvbGxlci5sb2FkQ2x1c3RlckRldGFpbHMiLCJJbXBvcnRDbHVzdGVyQ29udHJvbGxlci5pc0FsbEhvc3RzRm91bmQiLCJJbXBvcnRDbHVzdGVyQ29udHJvbGxlci5pbXBvcnQiLCJJbXBvcnRDbHVzdGVyQ29udHJvbGxlci5jYW5jZWwiLCJJbXBvcnRDbHVzdGVyQ29udHJvbGxlci5zZWxlY3RIb3N0Il0sIm1hcHBpbmdzIjoiQUFBQSwyQ0FBMkM7QUFPM0MsSUFBWSxXQUFXLFdBQU0sMkJBQTJCLENBQUMsQ0FBQTtBQUV6RDtJQVFJQSxpQ0FDWUEsVUFBMEJBLEVBQzFCQSxZQUFpQkEsRUFDakJBLFNBQThCQSxFQUM5QkEsY0FBOEJBLEVBQzlCQSxjQUE4QkEsRUFDOUJBLHNCQUE4Q0EsRUFDOUNBLGFBQTRCQTtRQU41QkMsZUFBVUEsR0FBVkEsVUFBVUEsQ0FBZ0JBO1FBQzFCQSxpQkFBWUEsR0FBWkEsWUFBWUEsQ0FBS0E7UUFDakJBLGNBQVNBLEdBQVRBLFNBQVNBLENBQXFCQTtRQUM5QkEsbUJBQWNBLEdBQWRBLGNBQWNBLENBQWdCQTtRQUM5QkEsbUJBQWNBLEdBQWRBLGNBQWNBLENBQWdCQTtRQUM5QkEsMkJBQXNCQSxHQUF0QkEsc0JBQXNCQSxDQUF3QkE7UUFDOUNBLGtCQUFhQSxHQUFiQSxhQUFhQSxDQUFlQTtRQUNwQ0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxFQUFFQSxDQUFDQTtRQUN4QkEsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFDbEJBLENBQUNBO0lBRU1ELGtEQUFnQkEsR0FB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U0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsQ0FBQ0E7SUFDckNBLENBQUNBO0lBQ01OLDRDQUFVQSxHQUFqQkEsVUFBa0JBLElBQVNBO1FBQ3ZCTyxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxJQUFJQSxDQUFBQTtJQUM3QkEsQ0FBQ0E7SUF0RU1QLCtCQUFPQSxHQUFrQkEsQ0FBQ0EsTUFBTUEsRUFBRUEsUUFBUUEsRUFBRUEsV0FBV0EsRUFBRUEsZ0JBQWdCQSxFQUFFQSxnQkFBZ0JBLEVBQUVBLHdCQUF3QkEsRUFBRUEsZUFBZUEsQ0FBQ0EsQ0FBQ0E7SUF1RW5KQSw4QkFBQ0E7QUFBREEsQ0E5RUEsQUE4RUNBLElBQUE7QUE5RVksK0JBQXVCLDBCQThFbkMsQ0FBQSIsImZpbGUiOiJtb2R1bGVzL2NsdXN0ZXJzL2ltcG9ydC1jbHVzdGVyL2ltcG9ydC1jbHVzdGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy90c2QuZC50c1wiIC8+XG5cbmltcG9ydCB7U2VydmVyU2VydmljZX0gZnJvbSAnLi4vLi4vcmVzdC9zZXJ2ZXInO1xuaW1wb3J0IHtOb2RlU3RhdGV9IGZyb20gJy4uLy4uL3Jlc3Qvc2VydmVyJztcbmltcG9ydCB7Q2x1c3RlclNlcnZpY2V9IGZyb20gJy4uLy4uL3Jlc3QvY2x1c3RlcnMnO1xuaW1wb3J0IHtSZXF1ZXN0U2VydmljZX0gZnJvbSAgJy4uLy4uL3Jlc3QvcmVxdWVzdCc7XG5pbXBvcnQge1JlcXVlc3RUcmFja2luZ1NlcnZpY2V9IGZyb20gJy4uLy4uL3JlcXVlc3RzL3JlcXVlc3QtdHJhY2tpbmctc3ZjJztcbmltcG9ydCAqIGFzIE1vZGFsSGVscGVyIGZyb20gJy4uLy4uL21vZGFsL21vZGFsLWhlbHBlcnMnO1xuXG5leHBvcnQgY2xhc3MgSW1wb3J0Q2x1c3RlckNvbnRyb2xsZXIge1xuICAgIHByaXZhdGUgY2x1c3RlclN1bW1hcnk6IGFueTtcbiAgICBwcml2YXRlIGJvb3RzdHJhcE5vZGU6IGFueTtcbiAgICBwcml2YXRlIGZyZWVIb3N0czogQXJyYXk8YW55PjtcbiAgICBwcml2YXRlIHN0ZXA6IG51bWJlcjtcbiAgICBwcml2YXRlIGVycm9yOiBzdHJpbmc7XG5cbiAgICBzdGF0aWMgJGluamVjdDogQXJyYXk8c3RyaW5nPiA9IFsnJGxvZycsICckbW9kYWwnLCAnJGxvY2F0aW9uJywgJ0NsdXN0ZXJTZXJ2aWNlJywgJ1JlcXVlc3RTZXJ2aWNlJywgJ1JlcXVlc3RUcmFja2luZ1NlcnZpY2UnLCAnU2VydmVyU2VydmljZSddO1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGxvZ1NlcnZpY2U6IG5nLklMb2dTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG1vZGFsU2VydmljZTogYW55LFxuICAgICAgICBwcml2YXRlICRsb2NhdGlvbjogbmcuSUxvY2F0aW9uU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBjbHVzdGVyU2VydmljZTogQ2x1c3RlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgcmVxdWVzdFNlcnZpY2U6IFJlcXVlc3RTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHJlcXVlc3RUcmFja2luZ1NlcnZpY2U6IFJlcXVlc3RUcmFja2luZ1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgc2VydmVyU2VydmljZTogU2VydmVyU2VydmljZSkge1xuICAgICAgICB0aGlzLmxvYWRBbGxGcmVlSG9zdHMoKTtcbiAgICAgICAgdGhpcy5zdGVwID0gMTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZEFsbEZyZWVIb3N0cygpIHtcbiAgICAgICAgdGhpcy5zZXJ2ZXJTZXJ2aWNlLmdldEFsbEZyZWVIb3N0cygpLnRoZW4oKGZyZWVIb3N0cykgPT4ge1xuICAgICAgICAgICAgdGhpcy5mcmVlSG9zdHMgPSBmcmVlSG9zdHM7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkQ2x1c3RlckRldGFpbHMoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZXJyb3IgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuY2x1c3RlclNlcnZpY2UuZ2V0SW1wb3J0Q2x1c3RlckRlYXRpbHModGhpcy5ib290c3RyYXBOb2RlLmhvc3RuYW1lKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNsdXN0ZXJTdW1tYXJ5ID0gcmVzdWx0LmRhdGE7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGVwID0gMjtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2x1c3RlclN1bW1hcnkuY29tcGF0aWJsZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yID0gXCJDbHVzdGVyIHdpdGggdmVyc2lvbiAnXCIgKyB0aGlzLmNsdXN0ZXJTdW1tYXJ5LnZlcnNpb24gKyBcIicgaXMgbm90IGNvbXBhdGlibGUgLiBQbGVhc2UgZW5zdXJlIHRoYXQgQ2VwaCAyLjAgb3IgZ3JlYXRlciBpcyBpbnN0YWxsZWQuXCJcbiAgICAgICAgICAgICAgICB9ZWxzZSBpZighdGhpcy5pc0FsbEhvc3RzRm91bmQodGhpcy5jbHVzdGVyU3VtbWFyeSkpe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVycm9yID0gXCJPbmUgb3IgbW9yZSBvZiB0aGUgaG9zdHMgaW4gdGhpcyBjbHVzdGVyIGNhbm5vdCBiZSBmb3VuZC4gUGxlYXNlIGVuc3VyZSB0aGF0IENlcGggMi4wIG9yIGdyZWF0ZXIgaXMgaW5zdGFsbGVkIG9uIHRoaXMgaG9zdCBhbmQgdGhhdCBpdCBpcyBhdmFpbGFibGUgb24gdGhlIG5ldHdvcmsuIENsaWNrIFJlZnJlc2ggdG8gc2VhcmNoIGZvciB0aGlzIGhvc3QgYWdhaW4uXCJcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZXJyb3IgPSBcIkZhaWxlZCB0byByZXRyaXZlIGNsdXN0ZXIgaW5mb3JtYXRpb24gZnJvbSB0aGUgc2VsZWN0ZWQgaG9zdCAnXCIgKyB0aGlzLmJvb3RzdHJhcE5vZGUuaG9zdG5hbWUgKyBcIicuIFBsZWFzZSBzZWxlY3QgYSBtb25pdG9yIGhvc3QgYW5kIHRyeSBhZ2FpblwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZXJyb3IgPSBcIkZhaWxlZCB0byByZXRyaXZlIGNsdXN0ZXIgaW5mb3JtYXRpb24gZnJvbSB0aGUgc2VsZWN0ZWQgaG9zdCAnXCIgKyB0aGlzLmJvb3RzdHJhcE5vZGUuaG9zdG5hbWUgKyBcIicuIFBsZWFzZSBzZWxlY3QgYSBtb25pdG9yIGhvc3QgYW5kIHRyeSBhZ2FpblwiO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzQWxsSG9zdHNGb3VuZChjbHVzdGVyU3VtbWFyeTogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBfLmV2ZXJ5KGNsdXN0ZXJTdW1tYXJ5Lm5vZGVzLCAobm9kZTogYW55KSA9PiBub2RlLmZvdW5kKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW1wb3J0KCk6IHZvaWQge1xuICAgICAgICB2YXIgbm9kZXMgPSBfLm1hcCh0aGlzLmNsdXN0ZXJTdW1tYXJ5Lm5vZGVzLCAobm9kZTphbnkpID0+IG5vZGUubmFtZSk7XG4gICAgICAgIHZhciBjbHVzdGVyID0geyAnYm9vdHN0cmFwbm9kZSc6IHRoaXMuYm9vdHN0cmFwTm9kZS5ob3N0bmFtZSwgJ3R5cGUnOiAnY2VwaCcsICdub2Rlcyc6IG5vZGVzIH07XG4gICAgICAgIHRoaXMuY2x1c3RlclNlcnZpY2UuaW1wb3J0Q2VwaENsdXN0ZXIoY2x1c3RlcikudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnN0YXR1cyA9PT0gMjAyKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0U2VydmljZS5nZXQocmVzdWx0LmRhdGEudGFza2lkKS50aGVuKCh0YXNrKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFRyYWNraW5nU2VydmljZS5hZGQodGFzay5pZCwgdGFzay5uYW1lKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB2YXIgbW9kYWwgPSBNb2RhbEhlbHBlci5TdWNjZXNzZnVsUmVxdWVzdCh0aGlzLm1vZGFsU2VydmljZSwge1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogJ0ltcG9ydCBDbHVzdGVyIHJlcXVlc3QgaXMgYmVpbmcgcHJvY2Vzc2VkJyxcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyOiAnLnVzbUNsaWVudEFwcCdcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBtb2RhbC4kc2NvcGUuJGhpZGUgPSBfLndyYXAobW9kYWwuJHNjb3BlLiRoaWRlLCAoJGhpZGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgJGhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbG9jYXRpb24ucGF0aCgnL3Rhc2tzLycgKyByZXN1bHQuZGF0YS50YXNraWQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dTZXJ2aWNlLmVycm9yKCdGYWlsZWQgdG8gaW1wb3J0IHRoZSBjbHVzdGVyOicsIHJlc3VsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBjYW5jZWwoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuJGxvY2F0aW9uLnBhdGgoJy9jbHVzdGVycycpO1xuICAgIH1cbiAgICBwdWJsaWMgc2VsZWN0SG9zdChob3N0OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5ib290c3RyYXBOb2RlID0gaG9zdFxuICAgIH1cbn0iXX0=
