// <reference path="../typings/tsd.d.ts" />
var StorageProfileDisksController = (function () {
    function StorageProfileDisksController($q, serverSvc, storageProfileSvc) {
        this.$q = $q;
        this.serverSvc = serverSvc;
        this.storageProfileSvc = storageProfileSvc;
        this.add = false;
        this.addingProfile = false;
        this.loadData();
    }
    StorageProfileDisksController.prototype.loadData = function () {
        var _this = this;
        if (!this.hosts) {
            this.hosts = this.hostsCallback();
        }
        this.storageProfileDisks = {};
        this.storageProfileSvc.getList().then(function (list) {
            _this.storageProfiles = list;
            _this.selectedProfile = _this.storageProfiles[0];
            for (var _i = 0, _a = _this.storageProfiles; _i < _a.length; _i++) {
                var storageProfile = _a[_i];
                _this.storageProfileDisks[storageProfile.name] = [];
            }
            for (var _b = 0, _c = _this.hosts; _b < _c.length; _b++) {
                var host = _c[_b];
                for (var _d = 0, _e = host.disks; _d < _e.length; _d++) {
                    var disk = _e[_d];
                    if (disk.Type === 'disk' && disk.Used === false && disk.StorageProfile && disk.StorageProfile.length > 0) {
                        disk.nodeid = host.id;
                        disk.hostname = host.hostname.split('.')[0];
                        _this.storageProfileDisks[disk.StorageProfile].push(disk);
                    }
                }
            }
        });
    };
    StorageProfileDisksController.prototype.selectStorageProfile = function (selectedProfile) {
        this.selectedProfile = selectedProfile;
    };
    StorageProfileDisksController.prototype.getDisksForStorageProfile = function (storageProfile) {
        return storageProfile && this.storageProfileDisks[storageProfile.name];
    };
    StorageProfileDisksController.prototype.getStorageProfileSize = function (storageProfile) {
        var size = _.reduce(this.storageProfileDisks[storageProfile.name], function (size, disk) {
            return size + disk.Size;
        }, 0);
        return size;
    };
    StorageProfileDisksController.prototype.diskMoved = function (storageProfile, disk) {
        var _this = this;
        console.log(disk);
        this.serverSvc.updateDiskStorageProfile(disk.nodeid, disk.DiskId, storageProfile.name).then(function (result) {
            if (result.status === 200) {
                var prevProfile = disk['StorageProfile'];
                disk['StorageProfile'] = storageProfile.name;
                _.remove(_this.storageProfileDisks[prevProfile], function (d) {
                    return disk.nodeid === d.nodeid && disk.DevName === d.DevName;
                });
                _this.storageProfileDisks[storageProfile.name].push(disk);
            }
        });
    };
    StorageProfileDisksController.prototype.addProfile = function (profileName) {
        var _this = this;
        this.storageProfileSvc.add({ name: profileName }).then(function (result) {
            if (result.status === 200) {
                _this.add = false;
                return _this.storageProfileSvc.getByName(profileName);
            }
        }).then(function (storageProfile) {
            _this.storageProfiles.push(storageProfile);
            _this.storageProfileDisks[profileName] = [];
        });
    };
    StorageProfileDisksController.$inject = [
        '$q',
        'ServerService',
        'StorageProfileService'
    ];
    return StorageProfileDisksController;
})();
exports.StorageProfileDisksController = StorageProfileDisksController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvY2x1c3RlcnMvc3RvcmFnZXByb2ZpbGUvc3RvcmFnZXByb2ZpbGUtZGlza3MtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJTdG9yYWdlUHJvZmlsZURpc2tzQ29udHJvbGxlciIsIlN0b3JhZ2VQcm9maWxlRGlza3NDb250cm9sbGVyLmNvbnN0cnVjdG9yIiwiU3RvcmFnZVByb2ZpbGVEaXNrc0NvbnRyb2xsZXIubG9hZERhdGEiLCJTdG9yYWdlUHJvZmlsZURpc2tzQ29udHJvbGxlci5zZWxlY3RTdG9yYWdlUHJvZmlsZSIsIlN0b3JhZ2VQcm9maWxlRGlza3NDb250cm9sbGVyLmdldERpc2tzRm9yU3RvcmFnZVByb2ZpbGUiLCJTdG9yYWdlUHJvZmlsZURpc2tzQ29udHJvbGxlci5nZXRTdG9yYWdlUHJvZmlsZVNpemUiLCJTdG9yYWdlUHJvZmlsZURpc2tzQ29udHJvbGxlci5kaXNrTW92ZWQiLCJTdG9yYWdlUHJvZmlsZURpc2tzQ29udHJvbGxlci5hZGRQcm9maWxlIl0sIm1hcHBpbmdzIjoiQUFBQSwyQ0FBMkM7QUFRM0M7SUFjSUEsdUNBQ1lBLEVBQWdCQSxFQUNoQkEsU0FBd0JBLEVBQ3hCQSxpQkFBd0NBO1FBRnhDQyxPQUFFQSxHQUFGQSxFQUFFQSxDQUFjQTtRQUNoQkEsY0FBU0EsR0FBVEEsU0FBU0EsQ0FBZUE7UUFDeEJBLHNCQUFpQkEsR0FBakJBLGlCQUFpQkEsQ0FBdUJBO1FBWjVDQSxRQUFHQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUdaQSxrQkFBYUEsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFVMUJBLElBQUlBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBO0lBQ3BCQSxDQUFDQTtJQUVNRCxnREFBUUEsR0FBZkE7UUFBQUUsaUJBcUJDQTtRQXBCR0EsRUFBRUEsQ0FBQUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDYkEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsQ0FB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Q0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3hCQSxLQUFJQSxDQUFDQSxHQUFHQSxHQUFHQSxLQUFLQSxDQUFDQTtnQkFDakJBLE1BQU1BLENBQUNBLEtBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsQ0FBQ0E7WUFDekRBLENBQUNBO1FBQ0xBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFVBQUNBLGNBQThCQTtZQUNuQ0EsS0FBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0E7WUFDMUNBLEtBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFDL0NBLENBQUNBLENBQUNBLENBQUNBO0lBQ1BBLENBQUNBO0lBMUVNUCxxQ0FBT0EsR0FBa0JBO1FBQzVCQSxJQUFJQTtRQUNKQSxlQUFlQTtRQUNmQSx1QkFBdUJBO0tBQzFCQSxDQUFDQTtJQXVFTkEsb0NBQUNBO0FBQURBLENBcEZBLEFBb0ZDQSxJQUFBO0FBcEZZLHFDQUE2QixnQ0FvRnpDLENBQUEiLCJmaWxlIjoibW9kdWxlcy9jbHVzdGVycy9zdG9yYWdlcHJvZmlsZS9zdG9yYWdlcHJvZmlsZS1kaXNrcy1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy90c2QuZC50c1wiIC8+XG5cbmltcG9ydCB7U3RvcmFnZVByb2ZpbGV9IGZyb20gJy4uLy4uL3Jlc3Qvc3RvcmFnZS1wcm9maWxlJztcblxuaW1wb3J0IHtTZXJ2ZXJTZXJ2aWNlfSBmcm9tICcuLi8uLi9yZXN0L3NlcnZlcic7XG5pbXBvcnQge1N0b3JhZ2VQcm9maWxlU2VydmljZX0gZnJvbSAnLi4vLi4vcmVzdC9zdG9yYWdlLXByb2ZpbGUnO1xuaW1wb3J0IHtudW1lcmFsfSBmcm9tICcuLi8uLi9iYXNlL2xpYnMnO1xuXG5leHBvcnQgY2xhc3MgU3RvcmFnZVByb2ZpbGVEaXNrc0NvbnRyb2xsZXIge1xuICAgIHByaXZhdGUgaG9zdHM7XG4gICAgcHJpdmF0ZSBob3N0c0NhbGxiYWNrO1xuICAgIHByaXZhdGUgc3RvcmFnZVByb2ZpbGVzOiBTdG9yYWdlUHJvZmlsZVtdO1xuICAgIHByaXZhdGUgc2VsZWN0ZWRQcm9maWxlOiBTdG9yYWdlUHJvZmlsZTtcbiAgICBwcml2YXRlIGFkZCA9IGZhbHNlO1xuICAgIHByaXZhdGUgc3RvcmFnZVByb2ZpbGVEaXNrczoge307XG4gICAgcHJpdmF0ZSBzdG9yYWdlRGlza3M6IGFueVtdO1xuICAgIHByaXZhdGUgYWRkaW5nUHJvZmlsZSA9IGZhbHNlO1xuICAgIHN0YXRpYyAkaW5qZWN0OiBBcnJheTxzdHJpbmc+ID0gW1xuICAgICAgICAnJHEnLFxuICAgICAgICAnU2VydmVyU2VydmljZScsXG4gICAgICAgICdTdG9yYWdlUHJvZmlsZVNlcnZpY2UnXG4gICAgXTtcbiAgICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgJHE6IG5nLklRU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBzZXJ2ZXJTdmM6IFNlcnZlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgc3RvcmFnZVByb2ZpbGVTdmM6IFN0b3JhZ2VQcm9maWxlU2VydmljZSkge1xuICAgICAgICB0aGlzLmxvYWREYXRhKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGxvYWREYXRhKCkge1xuICAgICAgICBpZighdGhpcy5ob3N0cykge1xuICAgICAgICAgICAgdGhpcy5ob3N0cyA9IHRoaXMuaG9zdHNDYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3RvcmFnZVByb2ZpbGVEaXNrcyA9IHt9O1xuICAgICAgICB0aGlzLnN0b3JhZ2VQcm9maWxlU3ZjLmdldExpc3QoKS50aGVuKChsaXN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0b3JhZ2VQcm9maWxlcyA9IGxpc3Q7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkUHJvZmlsZSA9IHRoaXMuc3RvcmFnZVByb2ZpbGVzWzBdO1xuICAgICAgICAgICAgZm9yICh2YXIgc3RvcmFnZVByb2ZpbGUgb2YgdGhpcy5zdG9yYWdlUHJvZmlsZXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2VQcm9maWxlRGlza3Nbc3RvcmFnZVByb2ZpbGUubmFtZV0gPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGhvc3Qgb2YgdGhpcy5ob3N0cykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGRpc2sgb2YgaG9zdC5kaXNrcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGlzay5UeXBlID09PSAnZGlzaycgJiYgZGlzay5Vc2VkID09PSBmYWxzZSAmJiBkaXNrLlN0b3JhZ2VQcm9maWxlICYmIGRpc2suU3RvcmFnZVByb2ZpbGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlzay5ub2RlaWQgPSBob3N0LmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlzay5ob3N0bmFtZSA9IGhvc3QuaG9zdG5hbWUuc3BsaXQoJy4nKVswXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmFnZVByb2ZpbGVEaXNrc1tkaXNrLlN0b3JhZ2VQcm9maWxlXS5wdXNoKGRpc2spO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2VsZWN0U3RvcmFnZVByb2ZpbGUoc2VsZWN0ZWRQcm9maWxlOiBTdG9yYWdlUHJvZmlsZSkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkUHJvZmlsZSA9IHNlbGVjdGVkUHJvZmlsZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0RGlza3NGb3JTdG9yYWdlUHJvZmlsZShzdG9yYWdlUHJvZmlsZTogU3RvcmFnZVByb2ZpbGUpOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBzdG9yYWdlUHJvZmlsZSAmJiB0aGlzLnN0b3JhZ2VQcm9maWxlRGlza3Nbc3RvcmFnZVByb2ZpbGUubmFtZV07XG4gICAgfVxuXG4gICAgcHVibGljIGdldFN0b3JhZ2VQcm9maWxlU2l6ZShzdG9yYWdlUHJvZmlsZTogU3RvcmFnZVByb2ZpbGUpOiBudW1iZXIge1xuICAgICAgICB2YXIgc2l6ZSA9IF8ucmVkdWNlKHRoaXMuc3RvcmFnZVByb2ZpbGVEaXNrc1tzdG9yYWdlUHJvZmlsZS5uYW1lXSwgZnVuY3Rpb24oc2l6ZSwgZGlzazogYW55KSB7XG4gICAgICAgICAgICByZXR1cm4gc2l6ZSArIGRpc2suU2l6ZTtcbiAgICAgICAgfSwgMClcbiAgICAgICAgcmV0dXJuIHNpemU7XG4gICAgfVxuXG4gICAgcHVibGljIGRpc2tNb3ZlZChzdG9yYWdlUHJvZmlsZTogU3RvcmFnZVByb2ZpbGUsIGRpc2spIHtcbiAgICAgICAgY29uc29sZS5sb2coZGlzayk7XG4gICAgICAgIHRoaXMuc2VydmVyU3ZjLnVwZGF0ZURpc2tTdG9yYWdlUHJvZmlsZShkaXNrLm5vZGVpZCwgZGlzay5EaXNrSWQsIHN0b3JhZ2VQcm9maWxlLm5hbWUpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJldlByb2ZpbGUgPSBkaXNrWydTdG9yYWdlUHJvZmlsZSddO1xuICAgICAgICAgICAgICAgIGRpc2tbJ1N0b3JhZ2VQcm9maWxlJ10gPSBzdG9yYWdlUHJvZmlsZS5uYW1lO1xuICAgICAgICAgICAgICAgIF8ucmVtb3ZlKHRoaXMuc3RvcmFnZVByb2ZpbGVEaXNrc1twcmV2UHJvZmlsZV0sIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpc2subm9kZWlkID09PSBkLm5vZGVpZCAmJiBkaXNrLkRldk5hbWUgPT09IGQuRGV2TmFtZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2VQcm9maWxlRGlza3Nbc3RvcmFnZVByb2ZpbGUubmFtZV0ucHVzaChkaXNrKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZFByb2ZpbGUocHJvZmlsZU5hbWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLnN0b3JhZ2VQcm9maWxlU3ZjLmFkZCh7IG5hbWU6IHByb2ZpbGVOYW1lIH0pLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZVByb2ZpbGVTdmMuZ2V0QnlOYW1lKHByb2ZpbGVOYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkudGhlbigoc3RvcmFnZVByb2ZpbGU6IFN0b3JhZ2VQcm9maWxlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0b3JhZ2VQcm9maWxlcy5wdXNoKHN0b3JhZ2VQcm9maWxlKTtcbiAgICAgICAgICAgIHRoaXMuc3RvcmFnZVByb2ZpbGVEaXNrc1twcm9maWxlTmFtZV0gPSBbXTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19
